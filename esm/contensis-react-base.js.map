<<<<<<< HEAD
{"version":3,"file":"contensis-react-base.js","sources":["../src/server/util/displayStartupConfiguration.ts","../src/server/features/reverse-proxy/index.js","../src/server/features/caching/cacheDuration.schema.js","../src/server/util/staticPaths.js","../src/server/middleware/bundleManipulation.js","../src/server/middleware/resolveStartup.js","../src/server/features/static-assets/index.js","../node_modules/fromentries/index.js","../src/server/features/response-handler/types.js","../src/server/features/response-handler/index.js","../src/server/util/stringifyAttributes.js","../src/server/webApp.js","../src/server/internalServer.ts"],"sourcesContent":["const servers = SERVERS; /* global SERVERS */\nconst projects = PROJECTS; /* global PROJECTS */\n\nconst DisplayStartupConfiguration = config => {\n  /* eslint-disable no-console */\n  console.log();\n  console.log(\n    `Configured servers:\n`,\n    JSON.stringify(servers, null, 2)\n  );\n  console.log();\n  console.log(\n    `Configured projects:\n`,\n    JSON.stringify(projects, null, 2)\n  );\n  console.log();\n  console.log(\n    'Reverse proxy paths: ',\n    JSON.stringify(config.reverseProxyPaths, null, 2)\n  );\n  console.log();\n\n  /* eslint-enable no-console */\n};\n\nexport default DisplayStartupConfiguration;\n","import httpProxy from 'http-proxy';\n\nconst servers = SERVERS; /* global SERVERS */\nexport const apiProxy = httpProxy.createProxyServer();\n\nconst reverseProxies = (app, reverseProxyPaths) => {\n  deliveryApiProxy(apiProxy, app);\n\n  app.all(reverseProxyPaths, (req, res) => {\n    const target =\n      req.hostname.indexOf('preview-') ||\n      req.hostname.indexOf('preview.') ||\n      req.hostname === 'localhost'\n        ? servers.previewIis || servers.iis\n        : servers.iis;\n\n    apiProxy.web(req, res, { target, changeOrigin: true });\n    apiProxy.on('error', e => {\n      /* eslint-disable no-console */\n      console.log(\n        `Proxy Request for ${req.path} HostName:${req.hostname} failed with ${e}`\n      );\n      /* eslint-enable no-console */\n    });\n  });\n};\n\nconst deliveryApiProxy = (apiProxy, app) => {\n  // This is just here to stop cors requests on localhost. In Production this is mapped using varnish.\n  app.all(['/api/delivery/*', '/api/image/*'], (req, res) => {\n    /* eslint-disable no-console */\n    const target = servers.cms;\n    console.log(`Proxying api request to ${servers.alias}`);\n    apiProxy.web(req, res, {\n      target,\n      changeOrigin: true,\n    });\n    apiProxy.on('error', e => {\n      /* eslint-disable no-console */\n      console.log(\n        `Proxy request for ${req.path} HostName:${req.hostname} failed with ${e}`\n      );\n      /* eslint-enable no-console */\n    });\n  });\n};\n\nexport default reverseProxies;\n","export const CacheDuration = {\n  200: '3600',\n  404: '5',\n  static: '31536000', // Believe it or not these two max ages are the same in runtime\n  expressStatic: '31557600h', // Believe it or not these two max ages are the same in runtime\n};\n\nexport const getCacheDuration = (status = 200) => {\n  if (status > 400) return CacheDuration[404];\n  return CacheDuration[200];\n};\n","export const replaceStaticPath = (string, staticFolderPath = 'static') =>\n  string.replace(/static\\//g, `${staticFolderPath}/`);\n","import fs from 'fs';\nimport path from 'path';\nimport { replaceStaticPath } from '../util/staticPaths';\n\nexport const bundleManipulationMiddleware =\n  ({ appRootPath, maxage, staticRoutePath }) =>\n  (req, res, next) => {\n    const filename = path.basename(req.path);\n    const modernBundle = filename.endsWith('.mjs');\n    const legacyBundle = filename.endsWith('.js');\n    if ((legacyBundle || modernBundle) && filename.startsWith('runtime.')) {\n      const jsRuntimeLocation = path.resolve(\n        appRootPath,\n        `dist/static/${modernBundle ? 'modern/js' : 'legacy/js'}/${filename}`\n      );\n      try {\n        const jsRuntimeBundle = fs.readFileSync(jsRuntimeLocation, 'utf8');\n        const modifiedBundle = replaceStaticPath(\n          jsRuntimeBundle,\n          staticRoutePath\n        );\n        if (maxage) res.set('Cache-Control', `public, max-age=${maxage}`);\n        res.type('.js').send(modifiedBundle);\n        return;\n      } catch (readError) {\n        // eslint-disable-next-line no-console\n        console.log(\n          `Unable to find js runtime bundle at '${jsRuntimeLocation}'`,\n          readError\n        );\n        next();\n      }\n    } else {\n      next();\n    }\n  };\n","import path from 'path';\n\n/**\n *\n * @param { appRootPath: string; maxage: number; staticFolderPath: string, startupScriptFilename: string } args\n * @returns Response | next()\n * A middleware function to resolve /dist/static/startup.js under a supplied startupScriptFilename variable\n */\nexport const resolveStartupMiddleware = ({\n  appRootPath,\n  maxage,\n  staticFolderPath,\n  startupScriptFilename,\n}) => (req, res, next) => {\n  if (\n    startupScriptFilename !== 'startup.js' &&\n    req.path === `/${startupScriptFilename}`\n  ) {\n    const startupFilePath = `dist/${staticFolderPath}/startup.js`;\n    const startupFileLocation = path.resolve(appRootPath, startupFilePath);\n\n    if (maxage) res.set('Cache-Control', `public, max-age=${maxage}`);\n\n    try {\n      res.sendFile(startupFileLocation);\n    } catch (sendFileError) {\n      // eslint-disable-next-line no-console\n      console.log(\n        `Unable to send file startup.js at '${startupFileLocation}'`,\n        sendFileError\n      );\n      next();\n    }\n  } else {\n    next();\n  }\n};\n","import express from 'express';\nimport { CacheDuration } from '~/server/features/caching/cacheDuration.schema';\nimport { bundleManipulationMiddleware } from '~/server/middleware/bundleManipulation';\nimport { resolveStartupMiddleware } from '~/server/middleware/resolveStartup';\n\n// Serving static assets\nconst staticAssets = (\n  app,\n  {\n    appRootPath = require('app-root-path').path,\n    scripts = {},\n    startupScriptFilename = 'startup.js',\n    staticFolderPath = 'static',\n    staticRoutePath = 'static',\n    staticRoutePaths = [],\n  }\n) => {\n  app.use(\n    [\n      `/${staticRoutePath}`,\n      ...staticRoutePaths.map(p => `/${p}`),\n      `/${staticFolderPath}`,\n    ],\n    bundleManipulationMiddleware({\n      appRootPath,\n      // these maxage values are different in config but the same in runtime,\n      // this one is the true value in seconds\n      maxage: CacheDuration.static,\n      staticRoutePath,\n    }),\n    resolveStartupMiddleware({\n      appRootPath,\n      maxage: CacheDuration.static,\n      startupScriptFilename: scripts.startup || startupScriptFilename,\n      staticFolderPath,\n    }),\n    express.static(`dist/${staticFolderPath}`, {\n      // these maxage values are different in config but the same in runtime,\n      // this one is somehow converted and should end up being the same as CacheDuration.static\n      maxage: CacheDuration.expressStatic,\n    })\n  );\n};\n\nexport default staticAssets;\n","/*! fromentries. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */\nmodule.exports = function fromEntries (iterable) {\n  return [...iterable].reduce((obj, [key, val]) => {\n    obj[key] = val\n    return obj\n  }, {})\n}\n","export const ResponseMethod = {\n  send: 'send',\n  json: 'json',\n  end: 'end',\n};\n","/* eslint-disable no-console */\nimport { ResponseMethod } from './types';\n\n/**\n * Web Application Response handler, sends a prepared express js response\n * with the supplied content sending in the specified manner\n * @param {response} request express js request object\n * @param {response} response express js response object\n * @param {string | object} content the content to send in the response body\n * @param {function} send the response function to call e.g res.send() res.json() res.end()\n */\nconst handleResponse = (\n  request,\n  response,\n  content,\n  send = ResponseMethod.send\n) => {\n  // console.log('---', response.statusCode, '---');\n  response[send](content);\n};\n\nexport default handleResponse;\n","export default (attributes = {}) =>\n  Object.entries(attributes)\n    .map(\n      ([key, value], idx) =>\n        `${idx !== 0 ? ' ' : ''}${key}${value ? `=\"${value}\"` : ''}`\n    )\n    .join(' ');\n","import fs from 'fs';\nimport React from 'react';\nimport { StaticRouter } from 'react-router-dom';\nimport { Provider as ReduxProvider } from 'react-redux';\nimport Loadable from 'react-loadable';\nimport { renderToString } from 'react-dom/server';\nimport { matchRoutes } from 'react-router-config';\nimport { getBundles } from 'react-loadable/webpack';\nimport { ServerStyleSheet } from 'styled-components';\nimport Helmet from 'react-helmet';\nimport serialize from 'serialize-javascript';\nimport minifyCssString from 'minify-css-string';\nimport mapJson from 'jsonpath-mapper';\nimport { fromJS } from 'immutable';\n// import fromJSLeaveImmer from '~/util/fromJSLeaveImmer';\nimport fromEntries from 'fromentries';\n\nimport createStore from '~/redux/store/store';\nimport { history } from '~/redux/store/history';\nimport rootSaga from '~/redux/sagas/index.js';\n\nimport { setVersion, setVersionStatus } from '../redux/actions/version';\nimport { setCurrentProject } from '../routing/redux/actions';\nimport {\n  selectCurrentProject,\n  selectRouteEntry,\n} from '../routing/redux/selectors';\n\nimport { getCacheDuration } from './features/caching/cacheDuration.schema';\nimport handleResponse from './features/response-handler';\n\nimport { replaceStaticPath } from './util/staticPaths';\nimport pickProject from '~/util/pickProject';\nimport { deliveryApi } from '~/util/ContensisDeliveryApi';\nimport stringifyAttributes from './util/stringifyAttributes';\n\nconst addStandardHeaders = (state, response, packagejson, groups) => {\n  if (state) {\n    try {\n      console.info('About to add headers');\n      const routingSurrogateKeys = state.getIn(\n        ['routing', 'surrogateKeys'],\n        ''\n      );\n\n      const surrogateKeyHeader = ` ${packagejson.name}-app ${routingSurrogateKeys}`;\n\n      response.header('surrogate-key', surrogateKeyHeader);\n\n      addVarnishAuthenticationHeaders(state, response, groups);\n\n      response.setHeader(\n        'Surrogate-Control',\n        `max-age=${getCacheDuration(response.statusCode)}`\n      );\n    } catch (e) {\n      console.info('Error Adding headers', e.message);\n    }\n  }\n};\n\nconst addVarnishAuthenticationHeaders = (state, response, groups = {}) => {\n  if (state) {\n    try {\n      const stateEntry = selectRouteEntry(state);\n      const project = selectCurrentProject(state);\n      const { globalGroups, allowedGroups } = groups;\n      // console.info(globalGroups, allowedGroups);\n      let allGroups = Array.from((globalGroups && globalGroups[project]) || {});\n      if (\n        stateEntry &&\n        stateEntry.getIn(['authentication', 'isLoginRequired']) &&\n        allowedGroups &&\n        allowedGroups[project]\n      ) {\n        allGroups = [...allGroups, ...allowedGroups[project]];\n      }\n      response.header('x-contensis-viewer-groups', allGroups.join('|'));\n    } catch (e) {\n      console.info('Error adding authentication header', e);\n    }\n  }\n};\n\nconst readFileSync = path => fs.readFileSync(path, 'utf8');\n\nconst loadableBundleData = ({ stats, templates }, staticRoutePath, build) => {\n  const bundle = {};\n  try {\n    bundle.stats = JSON.parse(\n      readFileSync(stats.replace('/target', build ? `/${build}` : ''))\n    );\n  } catch (ex) {\n    //console.info(ex);\n    bundle.stats = null;\n  }\n  try {\n    bundle.templates = {\n      templateHTML: replaceStaticPath(\n        readFileSync(\n          templates.html.replace('/target', build ? `/${build}` : '')\n        ),\n        staticRoutePath\n      ),\n      templateHTMLStatic: replaceStaticPath(\n        readFileSync(\n          templates.static.replace('/target', build ? `/${build}` : '')\n        ),\n        staticRoutePath\n      ),\n      templateHTMLFragment: replaceStaticPath(\n        readFileSync(\n          templates.fragment.replace('/target', build ? `/${build}` : '')\n        ),\n        staticRoutePath\n      ),\n    };\n  } catch (ex) {\n    //console.info(ex);\n    bundle.templates = null;\n  }\n  return bundle;\n};\n\nconst webApp = (app, ReactApp, config) => {\n  const {\n    routes,\n    withReducers,\n    withSagas,\n    withEvents,\n    packagejson,\n    scripts = {},\n    staticFolderPath = 'static',\n    startupScriptFilename,\n    differentialBundles,\n    allowedGroups,\n    globalGroups,\n    disableSsrRedux,\n    handleResponses,\n  } = config;\n  const staticRoutePath = config.staticRoutePath || staticFolderPath;\n\n  const bundleData = {\n    default: loadableBundleData(config, staticRoutePath),\n    legacy: loadableBundleData(config, staticRoutePath, 'legacy'),\n    modern: loadableBundleData(config, staticRoutePath, 'modern'),\n  };\n  if (!bundleData.default || bundleData.default === {})\n    bundleData.default = bundleData.legacy || bundleData.modern;\n\n  const attributes = stringifyAttributes(scripts.attributes);\n  scripts.startup = scripts.startup || startupScriptFilename;\n\n  const responseHandler =\n    typeof handleResponses === 'function' ? handleResponses : handleResponse;\n\n  const versionInfo = JSON.parse(\n    fs.readFileSync(`dist/${staticFolderPath}/version.json`, 'utf8')\n  );\n\n  app.get('/*', (request, response) => {\n    const { url } = request;\n\n    const matchedStaticRoute = () =>\n      matchRoutes(routes.StaticRoutes, request.path);\n    const isStaticRoute = () => matchedStaticRoute().length > 0;\n    const staticRoute = isStaticRoute() && matchedStaticRoute()[0];\n\n    // Allow certain routes to avoid SSR\n    const onlyDynamic = staticRoute && staticRoute.route.ssr === false;\n    const onlySSR = staticRoute && staticRoute.route.ssrOnly === true;\n\n    const normaliseQs = q => (q && q.toLowerCase() === 'true' ? true : false);\n\n    // Determine functional params from QueryString and set access methods\n    const accessMethod = mapJson(request.query, {\n      DYNAMIC: ({ dynamic }) => normaliseQs(dynamic) || onlyDynamic,\n      REDUX: ({ redux }) => normaliseQs(redux),\n      FRAGMENT: ({ fragment }) => normaliseQs(fragment),\n      STATIC: ({ static: value }) => normaliseQs(value) || onlySSR,\n    });\n\n    const context = {};\n    // Track the current statusCode via the response object\n    response.status(200);\n\n    // Create a store (with a memory history) from our current url\n    const store = createStore(\n      withReducers,\n      fromJS({}),\n      history({\n        initialEntries: [url],\n      })\n    );\n\n    // dispatch any global and non-saga related actions before calling our JSX\n    const versionStatusFromHostname = deliveryApi.getVersionStatusFromHostname(\n      request.hostname\n    );\n\n    console.info(\n      `Request for ${request.path} hostname: ${request.hostname} versionStatus: ${versionStatusFromHostname}`\n    );\n\n    store.dispatch(\n      setVersionStatus(request.query.versionStatus || versionStatusFromHostname)\n    );\n    store.dispatch(setVersion(versionInfo.commitRef, versionInfo.buildNo));\n\n    const project = pickProject(request.hostname, request.query);\n\n    const groups = allowedGroups && allowedGroups[project];\n    store.dispatch(setCurrentProject(project, groups, request.hostname));\n\n    const modules = [];\n\n    const jsx = (\n      <Loadable.Capture report={moduleName => modules.push(moduleName)}>\n        <ReduxProvider store={store}>\n          <StaticRouter context={context} location={url}>\n            <ReactApp routes={routes} withEvents={withEvents} />\n          </StaticRouter>\n        </ReduxProvider>\n      </Loadable.Capture>\n    );\n\n    const buildBundleTags = bundles => {\n      // Take the bundles returned from Loadable.Capture\n      const bundleTags = bundles\n        .filter(b => b)\n        .map(bundle => {\n          if (bundle.publicPath.includes('/modern/'))\n            return differentialBundles\n              ? `<script ${attributes} type=\"module\" src=\"${replaceStaticPath(\n                  bundle.publicPath,\n                  staticRoutePath\n                )}\"></script>`\n              : null;\n          return `<script ${attributes} nomodule src=\"${replaceStaticPath(\n            bundle.publicPath,\n            staticRoutePath\n          )}\"></script>`;\n        })\n        .filter(f => f);\n\n      // Add the static startup script to the bundleTags\n      scripts.startup &&\n        bundleTags.push(\n          `<script ${attributes} src=\"/${staticRoutePath}/${scripts.startup}\"></script>`\n        );\n\n      return bundleTags;\n    };\n\n    const templates =\n      bundleData.default.templates || bundleData.legacy.templates;\n\n    const stats =\n      bundleData.modern.stats && bundleData.legacy.stats\n        ? fromEntries(\n            Object.entries(bundleData.modern.stats).map(([lib, paths]) => [\n              lib,\n              bundleData.legacy.stats[lib]\n                ? [...paths, ...bundleData.legacy.stats[lib]]\n                : paths,\n            ])\n          )\n        : bundleData.default.stats;\n\n    const { templateHTML, templateHTMLFragment, templateHTMLStatic } =\n      templates;\n\n    // Serve a blank HTML page with client scripts to load the app in the browser\n    if (accessMethod.DYNAMIC) {\n      // Dynamic doesn't need sagas\n      renderToString(jsx);\n\n      // Dynamic page render has only the necessary bundles to start up the app\n      // and does not include any react-loadable code-split bundles\n      const loadableBundles = getBundles(stats, modules);\n      const bundleTags = buildBundleTags(loadableBundles).join('');\n\n      const isDynamicHint = `<script ${attributes}>window.isDynamic = true;</script>`;\n\n      const responseHtmlDynamic = templateHTML\n        .replace('{{TITLE}}', '')\n        .replace('{{SEO_CRITICAL_METADATA}}', '')\n        .replace('{{CRITICAL_CSS}}', '')\n        .replace('{{APP}}', '')\n        .replace('{{LOADABLE_CHUNKS}}', bundleTags)\n        .replace('{{REDUX_DATA}}', isDynamicHint);\n      // Dynamic pages always return a 200 so we can run\n      // the app and serve up all errors inside the client\n      response.setHeader(\n        'Surrogate-Control',\n        `max-age=${getCacheDuration(200)}`\n      );\n      responseHandler(request, response, responseHtmlDynamic);\n    }\n\n    // Render the JSX server side and send response as per access method options\n    if (!accessMethod.DYNAMIC) {\n      store\n        .runSaga(rootSaga(withSagas))\n        .toPromise()\n        .then(() => {\n          const sheet = new ServerStyleSheet();\n\n          const html = renderToString(sheet.collectStyles(jsx));\n\n          const helmet = Helmet.renderStatic();\n          Helmet.rewind();\n          const htmlAttributes = helmet.htmlAttributes.toString();\n          let title = helmet.title.toString();\n          const metadata = helmet.meta.toString();\n\n          if (context.url) {\n            return response.redirect(302, context.url);\n          }\n\n          const reduxState = store.getState();\n\n          const styleTags = sheet.getStyleTags();\n\n          // After running rootSaga there should be an additional react-loadable\n          // code-split bundle for a page component as well as core app bundles\n          const loadableBundles = getBundles(stats, modules);\n          const bundleTags = buildBundleTags(loadableBundles).join('');\n\n          let serialisedReduxData = '';\n          if (context.status !== 404) {\n            // For a request that returns a redux state object as a response\n            if (accessMethod.REDUX) {\n              serialisedReduxData = serialize(reduxState, {\n                ignoreFunction: true,\n              });\n              addStandardHeaders(reduxState, response, packagejson, {\n                allowedGroups,\n                globalGroups,\n              });\n              responseHandler(request, response, serialisedReduxData, 'json');\n              return true;\n            }\n            if (!disableSsrRedux) {\n              serialisedReduxData = serialize(reduxState, {\n                ignoreFunction: true,\n              });\n              serialisedReduxData = `<script ${attributes}>window.REDUX_DATA = ${serialisedReduxData}</script>`;\n            }\n          }\n          if (context.status > 400) {\n            accessMethod.STATIC = true;\n          }\n\n          // Responses\n          let responseHTML = '';\n\n          if (context.status === 404)\n            title = '<title>404 page not found</title>';\n\n          // Static page served as a fragment\n          if (accessMethod.FRAGMENT && accessMethod.STATIC) {\n            responseHTML = minifyCssString(styleTags) + html;\n          }\n\n          // Page fragment served with client scripts and redux data that hydrate the app client side\n          if (accessMethod.FRAGMENT && !accessMethod.STATIC) {\n            responseHTML = templateHTMLFragment\n              .replace('{{TITLE}}', title)\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\n              .replace('{{CRITICAL_CSS}}', minifyCssString(styleTags))\n              .replace('{{APP}}', html)\n              .replace('{{LOADABLE_CHUNKS}}', bundleTags)\n              .replace('{{REDUX_DATA}}', serialisedReduxData);\n          }\n\n          // Full HTML page served statically\n          if (!accessMethod.FRAGMENT && accessMethod.STATIC) {\n            responseHTML = templateHTMLStatic\n              .replace('{{TITLE}}', title)\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\n              .replace('{{CRITICAL_CSS}}', minifyCssString(styleTags))\n              .replace('{{APP}}', html)\n              .replace('{{LOADABLE_CHUNKS}}', '');\n          }\n\n          // Full HTML page served with client scripts and redux data that hydrate the app client side\n          if (!accessMethod.FRAGMENT && !accessMethod.STATIC) {\n            responseHTML = templateHTML\n              .replace('{{TITLE}}', title)\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\n              .replace('{{CRITICAL_CSS}}', styleTags)\n              .replace('{{APP}}', html)\n              .replace('{{LOADABLE_CHUNKS}}', bundleTags)\n              .replace('{{REDUX_DATA}}', serialisedReduxData);\n          }\n\n          // Set response.status from React StaticRouter\n          if (typeof context.status === 'number')\n            response.status(context.status);\n\n          addStandardHeaders(reduxState, response, packagejson, {\n            allowedGroups,\n            globalGroups,\n          });\n          try {\n            // If react-helmet htmlAttributes are being used,\n            // replace the html tag with those attributes sepcified\n            // e.g. (lang, dir etc.)\n            if (htmlAttributes) {\n              responseHTML = responseHTML.replace(\n                /<html?.+?>/,\n                `<html ${htmlAttributes}>`\n              );\n            }\n            responseHandler(request, response, responseHTML);\n          } catch (err) {\n            console.info(err.message);\n          }\n        })\n        .catch(err => {\n          // Handle any error that occurred in any of the previous\n          // promises in the chain.\n          console.info(err);\n          response.status(500);\n          responseHandler(\n            request,\n            response,\n            `Error occurred: <br />${err.stack} <br />${JSON.stringify(err)}`\n          );\n        });\n      renderToString(jsx);\n\n      store.close();\n    }\n  });\n};\n\nexport default webApp;\n","import 'isomorphic-fetch';\nimport express, { Express } from 'express';\nimport Loadable from 'react-loadable';\nimport React from 'react';\n\nimport DisplayStartupConfiguration from './util/displayStartupConfiguration';\nimport ConfigureReverseProxies, { apiProxy } from './features/reverse-proxy';\nimport ServeStaticAssets from './features/static-assets';\nimport ConfigureWebApp from './webApp';\nimport { ServerConfig } from '~/config';\n\ndeclare let global: typeof globalThis & {\n  DISABLE_SSR_REDUX;\n  PACKAGE_JSON;\n  PROXY_DELIVERY_API;\n  REVERSE_PROXY_PATHS;\n};\n\nconst app = express();\n\nconst start = (\n  ReactApp: React.ComponentType,\n  config: ServerConfig,\n  ServerFeatures: (app: Express) => void\n) => {\n  global.PACKAGE_JSON = config.packagejson;\n  global.DISABLE_SSR_REDUX = config.disableSsrRedux;\n  global.PROXY_DELIVERY_API = config.proxyDeliveryApi;\n  global.REVERSE_PROXY_PATHS = Object(config.reverseProxyPaths);\n\n  app.disable('x-powered-by');\n\n  // Output some information about the used build/startup configuration\n  DisplayStartupConfiguration(config);\n\n  ServerFeatures(app);\n  // Set-up local proxy for images from cms, and delivery api requests\n  // to save doing rewrites and extra code\n  ConfigureReverseProxies(app, config.reverseProxyPaths);\n  ServeStaticAssets(app, config);\n  ConfigureWebApp(app, ReactApp, config);\n\n  app.on('ready', async () => {\n    // Configure DNS to make life easier\n    // await ConfigureLocalDNS();\n\n    Loadable.preloadAll().then(() => {\n      const server = app.listen(3001, () => {\n        console.info(`HTTP server is listening @ port 3001`);\n        setTimeout(function () {\n          app.emit('app_started');\n        }, 500);\n      });\n      app.on('stop', () => {\n        server.close(function () {\n          console.info('GoodBye :(');\n        });\n      });\n    });\n  });\n};\n\nexport default { app, apiProxy, start };\n"],"names":["servers","SERVERS","projects","PROJECTS","DisplayStartupConfiguration","config","console","log","JSON","stringify","reverseProxyPaths","apiProxy","httpProxy","createProxyServer","reverseProxies","app","deliveryApiProxy","all","req","res","target","hostname","indexOf","previewIis","iis","web","changeOrigin","on","e","path","cms","alias","CacheDuration","static","expressStatic","getCacheDuration","status","replaceStaticPath","string","staticFolderPath","replace","bundleManipulationMiddleware","appRootPath","maxage","staticRoutePath","next","filename","basename","modernBundle","endsWith","legacyBundle","startsWith","jsRuntimeLocation","resolve","jsRuntimeBundle","fs","readFileSync","modifiedBundle","set","type","send","readError","resolveStartupMiddleware","startupScriptFilename","startupFilePath","startupFileLocation","sendFile","sendFileError","staticAssets","require","scripts","staticRoutePaths","use","map","p","startup","express","ResponseMethod","json","end","handleResponse","request","response","content","attributes","Object","entries","key","value","idx","join","addStandardHeaders","state","packagejson","groups","info","routingSurrogateKeys","getIn","surrogateKeyHeader","name","header","addVarnishAuthenticationHeaders","setHeader","statusCode","message","stateEntry","selectRouteEntry","project","selectCurrentProject","globalGroups","allowedGroups","allGroups","Array","from","loadableBundleData","stats","templates","build","bundle","parse","ex","templateHTML","html","templateHTMLStatic","templateHTMLFragment","fragment","webApp","ReactApp","routes","withReducers","withSagas","withEvents","differentialBundles","disableSsrRedux","handleResponses","bundleData","default","legacy","modern","stringifyAttributes","responseHandler","versionInfo","get","url","matchedStaticRoute","matchRoutes","StaticRoutes","isStaticRoute","length","staticRoute","onlyDynamic","route","ssr","onlySSR","ssrOnly","normaliseQs","q","toLowerCase","accessMethod","mapJson","query","DYNAMIC","dynamic","REDUX","redux","FRAGMENT","STATIC","context","store","createStore","fromJS","history","initialEntries","versionStatusFromHostname","deliveryApi","getVersionStatusFromHostname","dispatch","setVersionStatus","versionStatus","setVersion","commitRef","buildNo","pickProject","setCurrentProject","modules","jsx","moduleName","push","ReduxProvider","buildBundleTags","bundles","bundleTags","filter","b","publicPath","includes","f","fromEntries","lib","paths","renderToString","loadableBundles","getBundles","isDynamicHint","responseHtmlDynamic","runSaga","rootSaga","toPromise","then","sheet","ServerStyleSheet","collectStyles","helmet","Helmet","renderStatic","rewind","htmlAttributes","toString","title","metadata","meta","redirect","reduxState","getState","styleTags","getStyleTags","serialisedReduxData","serialize","ignoreFunction","responseHTML","minifyCssString","err","catch","stack","close","start","ServerFeatures","global","PACKAGE_JSON","DISABLE_SSR_REDUX","PROXY_DELIVERY_API","proxyDeliveryApi","REVERSE_PROXY_PATHS","disable","ConfigureReverseProxies","ServeStaticAssets","ConfigureWebApp","Loadable","preloadAll","server","listen","setTimeout","emit"],"mappings":"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"}
=======
{"version":3,"file":"contensis-react-base.js","sources":["../src/server/util/displayStartupConfiguration.js","../src/server/core/reverseProxies.js","../src/server/cacheDuration.schema.js","../src/server/util/staticPaths.js","../src/server/middleware/bundleManipulation.js","../src/server/middleware/resolveStartup.js","../src/server/core/staticAssets.js","../node_modules/fromentries/index.js","../src/server/util/types.js","../src/server/util/handleResponse.js","../src/server/core/webApp.js","../src/server/internalServer.js"],"sourcesContent":["const servers = SERVERS; /* global SERVERS */\r\nconst projects = PROJECTS; /* global PROJECTS */\r\n\r\nconst DisplayStartupConfiguration = config => {\r\n  /* eslint-disable no-console */\r\n  console.log();\r\n  console.log(\r\n    `Configured servers:\r\n`,\r\n    JSON.stringify(servers, null, 2)\r\n  );\r\n  console.log();\r\n  console.log(\r\n    `Configured projects:\r\n`,\r\n    JSON.stringify(projects, null, 2)\r\n  );\r\n  console.log();\r\n  console.log(\r\n    'Reverse proxy paths: ',\r\n    JSON.stringify(config.reverseProxyPaths, null, 2)\r\n  );\r\n  console.log();\r\n\r\n  /* eslint-enable no-console */\r\n};\r\n\r\nexport default DisplayStartupConfiguration;\r\n","import httpProxy from 'http-proxy';\r\n\r\nconst servers = SERVERS; /* global SERVERS */\r\nexport const apiProxy = httpProxy.createProxyServer();\r\n\r\nconst reverseProxies = (app, reverseProxyPaths) => {\r\n  deliveryApiProxy(apiProxy, app);\r\n\r\n  app.all(reverseProxyPaths, (req, res) => {\r\n    const target =\r\n      req.hostname.indexOf('preview-') ||\r\n      req.hostname.indexOf('preview.') ||\r\n      req.hostname === 'localhost'\r\n        ? servers.previewIis || servers.iis\r\n        : servers.iis;\r\n\r\n    apiProxy.web(req, res, { target, changeOrigin: true });\r\n    apiProxy.on('error', e => {\r\n      /* eslint-disable no-console */\r\n      console.log(\r\n        `Proxy Request for ${req.path} HostName:${req.hostname} failed with ${e}`\r\n      );\r\n      /* eslint-enable no-console */\r\n    });\r\n  });\r\n};\r\n\r\nconst deliveryApiProxy = (apiProxy, app) => {\r\n  // This is just here to stop cors requests on localhost. In Production this is mapped using varnish.\r\n  app.all(['/api/delivery/*', '/api/image/*'], (req, res) => {\r\n    /* eslint-disable no-console */\r\n    const target = servers.cms;\r\n    console.log(`Proxying api request to ${servers.alias}`);\r\n    apiProxy.web(req, res, {\r\n      target,\r\n      changeOrigin: true,\r\n    });\r\n    apiProxy.on('error', e => {\r\n      /* eslint-disable no-console */\r\n      console.log(\r\n        `Proxy request for ${req.path} HostName:${req.hostname} failed with ${e}`\r\n      );\r\n      /* eslint-enable no-console */\r\n    });\r\n  });\r\n};\r\n\r\nexport default reverseProxies;\r\n","export const CacheDuration = {\r\n  200: '3600',\r\n  404: '5',\r\n  static: '31536000', // Believe it or not these two max ages are the same in runtime\r\n  expressStatic: '31557600h', // Believe it or not these two max ages are the same in runtime\r\n};\r\n\r\nexport const getCacheDuration = (status = 200) => {\r\n  if (status > 400) return CacheDuration[404];\r\n  return CacheDuration[200];\r\n};\r\n","export const replaceStaticPath = (string, staticFolderPath = 'static') =>\r\n  string.replace(/static\\//g, `${staticFolderPath}/`);\r\n","import fs from 'fs';\r\nimport path from 'path';\r\nimport { replaceStaticPath } from '../util/staticPaths';\r\n\r\nexport const bundleManipulationMiddleware = ({\r\n  appRootPath,\r\n  maxage,\r\n  staticRoutePath,\r\n}) => (req, res, next) => {\r\n  const filename = path.basename(req.path);\r\n  const modernBundle = filename.endsWith('.mjs');\r\n  const legacyBundle = filename.endsWith('.js');\r\n  if ((legacyBundle || modernBundle) && filename.startsWith('runtime.')) {\r\n    const jsRuntimeLocation = path.resolve(\r\n      appRootPath,\r\n      `dist/static/${modernBundle ? 'modern/js' : 'legacy/js'}/${filename}`\r\n    );\r\n    try {\r\n      const jsRuntimeBundle = fs.readFileSync(jsRuntimeLocation, 'utf8');\r\n      const modifiedBundle = replaceStaticPath(\r\n        jsRuntimeBundle,\r\n        staticRoutePath\r\n      );\r\n      if (maxage) res.set('Cache-Control', `public, max-age=${maxage}`);\r\n      res.type('.js').send(modifiedBundle);\r\n      return;\r\n    } catch (readError) {\r\n      // eslint-disable-next-line no-console\r\n      console.log(\r\n        `Unable to find js runtime bundle at '${jsRuntimeLocation}'`,\r\n        readError\r\n      );\r\n      next();\r\n    }\r\n  } else {\r\n    next();\r\n  }\r\n};\r\n","import path from 'path';\r\n\r\n/**\r\n *\r\n * @param { appRootPath: string; maxage: number; staticFolderPath: string, startupScriptFilename: string } args\r\n * @returns Response | next()\r\n * A middleware function to resolve /dist/static/startup.js under a supplied startupScriptFilename variable\r\n */\r\nexport const resolveStartupMiddleware = ({\r\n  appRootPath,\r\n  maxage,\r\n  staticFolderPath,\r\n  startupScriptFilename,\r\n}) => (req, res, next) => {\r\n  if (\r\n    startupScriptFilename !== 'startup.js' &&\r\n    req.path === `/${startupScriptFilename}`\r\n  ) {\r\n    const startupFilePath = `dist/${staticFolderPath}/startup.js`;\r\n    const startupFileLocation = path.resolve(appRootPath, startupFilePath);\r\n\r\n    if (maxage) res.set('Cache-Control', `public, max-age=${maxage}`);\r\n\r\n    try {\r\n      res.sendFile(startupFileLocation);\r\n    } catch (sendFileError) {\r\n      // eslint-disable-next-line no-console\r\n      console.log(\r\n        `Unable to send file startup.js at '${startupFileLocation}'`,\r\n        sendFileError\r\n      );\r\n      next();\r\n    }\r\n  } else {\r\n    next();\r\n  }\r\n};\r\n","import express from 'express';\r\nimport { CacheDuration } from '../cacheDuration.schema';\r\nimport { bundleManipulationMiddleware } from '../middleware/bundleManipulation';\r\nimport { resolveStartupMiddleware } from '../middleware/resolveStartup';\r\n\r\n// Serving static assets\r\nconst staticAssets = (\r\n  app,\r\n  {\r\n    appRootPath = require('app-root-path').path,\r\n    startupScriptFilename = 'startup.js',\r\n    staticFolderPath = 'static',\r\n    staticRoutePath = 'static',\r\n    staticRoutePaths = [],\r\n  }\r\n) => {\r\n  app.use(\r\n    [\r\n      `/${staticRoutePath}`,\r\n      ...staticRoutePaths.map(p => `/${p}`),\r\n      `/${staticFolderPath}`,\r\n    ],\r\n    bundleManipulationMiddleware({\r\n      appRootPath,\r\n      // these maxage values are different in config but the same in runtime,\r\n      // this one is the true value in seconds\r\n      maxage: CacheDuration.static,\r\n      staticRoutePath,\r\n    }),\r\n    resolveStartupMiddleware({\r\n      appRootPath,\r\n      maxage: CacheDuration.static,\r\n      startupScriptFilename,\r\n      staticFolderPath,\r\n    }),\r\n    express.static(`dist/${staticFolderPath}`, {\r\n      // these maxage values are different in config but the same in runtime,\r\n      // this one is somehow converted and should end up being the same as CacheDuration.static\r\n      maxage: CacheDuration.expressStatic,\r\n    })\r\n  );\r\n};\r\n\r\nexport default staticAssets;\r\n","/*! fromentries. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */\nmodule.exports = function fromEntries (iterable) {\n  return [...iterable].reduce((obj, [key, val]) => {\n    obj[key] = val\n    return obj\n  }, {})\n}\n","export const ResponseMethod = {\r\n  send: 'send',\r\n  json: 'json',\r\n  end: 'end',\r\n};\r\n","/* eslint-disable no-console */\r\nimport { ResponseMethod } from './types';\r\n\r\n/**\r\n * Web Application Response handler, sends a prepared express js response\r\n * with the supplied content sending in the specified manner\r\n * @param {response} request express js request object\r\n * @param {response} response express js response object\r\n * @param {string | object} content the content to send in the response body\r\n * @param {function} send the response function to call e.g res.send() res.json() res.end()\r\n */\r\nconst handleResponse = (\r\n  request,\r\n  response,\r\n  content,\r\n  send = ResponseMethod.send\r\n) => {\r\n  // console.log('---', response.statusCode, '---');\r\n  response[send](content);\r\n};\r\n\r\nexport default handleResponse;\r\n","import fs from 'fs';\r\nimport React from 'react';\r\nimport { StaticRouter } from 'react-router-dom';\r\nimport { Provider as ReduxProvider } from 'react-redux';\r\nimport Loadable from 'react-loadable';\r\nimport { renderToString } from 'react-dom/server';\r\nimport { getBundles } from 'react-loadable/webpack';\r\nimport { ServerStyleSheet } from 'styled-components';\r\nimport Helmet from 'react-helmet';\r\nimport serialize from 'serialize-javascript';\r\nimport minifyCssString from 'minify-css-string';\r\nimport { fromJS } from 'immutable';\r\n// import fromJSLeaveImmer from '~/core/util/fromJSLeaveImmer';\r\nimport fromEntries from 'fromentries';\r\n\r\nimport { history } from '~/core/redux/history';\r\n\r\nimport handleResponse from '../util/handleResponse';\r\n\r\nimport pickProject from '~/core/util/pickProject';\r\nimport { deliveryApi } from '~/core/util/ContensisDeliveryApi';\r\n\r\nimport { setCurrentProject } from '~/core/redux/actions/routing';\r\nimport { setVersion, setVersionStatus } from '~/core/redux/actions/version';\r\n\r\nimport {\r\n  selectCurrentProject,\r\n  selectRouteEntry,\r\n} from '~/core/redux/selectors/routing';\r\n\r\nimport createStore from '~/core/redux/store';\r\nimport rootSaga from '~/core/redux/sagas/index.js';\r\nimport { matchRoutes } from 'react-router-config';\r\nimport mapJson from 'jsonpath-mapper';\r\nimport { replaceStaticPath } from '../util/staticPaths';\r\nimport { getCacheDuration } from '../cacheDuration.schema';\r\n\r\nconst addStandardHeaders = (state, response, packagejson, groups) => {\r\n  if (state) {\r\n    try {\r\n      console.info('About to add headers');\r\n      const routingSurrogateKeys = state.getIn(\r\n        ['routing', 'surrogateKeys'],\r\n        ''\r\n      );\r\n\r\n      const surrogateKeyHeader = ` ${packagejson.name}-app ${routingSurrogateKeys}`;\r\n\r\n      response.header('surrogate-key', surrogateKeyHeader);\r\n\r\n      addVarnishAuthenticationHeaders(state, response, groups);\r\n\r\n      response.setHeader(\r\n        'Surrogate-Control',\r\n        `max-age=${getCacheDuration(response.statusCode)}`\r\n      );\r\n    } catch (e) {\r\n      console.info('Error Adding headers', e.message);\r\n    }\r\n  }\r\n};\r\n\r\nconst addVarnishAuthenticationHeaders = (state, response, groups = {}) => {\r\n  if (state) {\r\n    try {\r\n      const stateEntry = selectRouteEntry(state);\r\n      const project = selectCurrentProject(state);\r\n      const { globalGroups, allowedGroups } = groups;\r\n      // console.info(globalGroups, allowedGroups);\r\n      let allGroups = Array.from((globalGroups && globalGroups[project]) || {});\r\n      if (\r\n        stateEntry &&\r\n        stateEntry.getIn(['authentication', 'isLoginRequired']) &&\r\n        allowedGroups &&\r\n        allowedGroups[project]\r\n      ) {\r\n        allGroups = [...allGroups, ...allowedGroups[project]];\r\n      }\r\n      response.header('x-contensis-viewer-groups', allGroups.join('|'));\r\n    } catch (e) {\r\n      console.info('Error adding authentication header', e);\r\n    }\r\n  }\r\n};\r\n\r\nconst readFileSync = path => fs.readFileSync(path, 'utf8');\r\n\r\nconst loadableBundleData = ({ stats, templates }, staticRoutePath, build) => {\r\n  const bundle = {};\r\n  try {\r\n    bundle.stats = JSON.parse(\r\n      readFileSync(stats.replace('/target', build ? `/${build}` : ''))\r\n    );\r\n  } catch (ex) {\r\n    //console.info(ex);\r\n    bundle.stats = null;\r\n  }\r\n  try {\r\n    bundle.templates = {\r\n      templateHTML: replaceStaticPath(\r\n        readFileSync(\r\n          templates.html.replace('/target', build ? `/${build}` : '')\r\n        ),\r\n        staticRoutePath\r\n      ),\r\n      templateHTMLStatic: replaceStaticPath(\r\n        readFileSync(\r\n          templates.static.replace('/target', build ? `/${build}` : '')\r\n        ),\r\n        staticRoutePath\r\n      ),\r\n      templateHTMLFragment: replaceStaticPath(\r\n        readFileSync(\r\n          templates.fragment.replace('/target', build ? `/${build}` : '')\r\n        ),\r\n        staticRoutePath\r\n      ),\r\n    };\r\n  } catch (ex) {\r\n    //console.info(ex);\r\n    bundle.templates = null;\r\n  }\r\n  return bundle;\r\n};\r\n\r\nconst webApp = (app, ReactApp, config) => {\r\n  const {\r\n    routes,\r\n    withReducers,\r\n    withSagas,\r\n    withEvents,\r\n    packagejson,\r\n    staticFolderPath = 'static',\r\n    startupScriptFilename,\r\n    differentialBundles,\r\n    allowedGroups,\r\n    globalGroups,\r\n    disableSsrRedux,\r\n    handleResponses,\r\n  } = config;\r\n  const staticRoutePath = config.staticRoutePath || staticFolderPath;\r\n\r\n  const bundleData = {\r\n    default: loadableBundleData(config, staticRoutePath),\r\n    legacy: loadableBundleData(config, staticRoutePath, 'legacy'),\r\n    modern: loadableBundleData(config, staticRoutePath, 'modern'),\r\n  };\r\n  if (!bundleData.default || bundleData.default === {})\r\n    bundleData.default = bundleData.legacy || bundleData.modern;\r\n\r\n  const responseHandler =\r\n    typeof handleResponses === 'function' ? handleResponses : handleResponse;\r\n\r\n  const versionInfo = JSON.parse(\r\n    fs.readFileSync(`dist/${staticFolderPath}/version.json`, 'utf8')\r\n  );\r\n\r\n  app.get('/*', (request, response) => {\r\n    const { url } = request;\r\n\r\n    const matchedStaticRoute = () =>\r\n      matchRoutes(routes.StaticRoutes, request.path);\r\n    const isStaticRoute = () => matchedStaticRoute().length > 0;\r\n    const staticRoute = isStaticRoute() && matchedStaticRoute()[0];\r\n\r\n    // Allow certain routes to avoid SSR\r\n    const onlyDynamic = staticRoute && staticRoute.route.ssr === false;\r\n    const onlySSR = staticRoute && staticRoute.route.ssrOnly === true;\r\n\r\n    const normaliseQs = q => (q && q.toLowerCase() === 'true' ? true : false);\r\n\r\n    // Determine functional params from QueryString and set access methods\r\n    const accessMethod = mapJson(request.query, {\r\n      DYNAMIC: ({ dynamic }) => normaliseQs(dynamic) || onlyDynamic,\r\n      REDUX: ({ redux }) => normaliseQs(redux),\r\n      FRAGMENT: ({ fragment }) => normaliseQs(fragment),\r\n      STATIC: ({ static: value }) => normaliseQs(value) || onlySSR,\r\n    });\r\n\r\n    const context = {};\r\n    // Track the current statusCode via the response object\r\n    response.status(200);\r\n\r\n    // Create a store (with a memory history) from our current url\r\n    const store = createStore(\r\n      withReducers,\r\n      fromJS({}),\r\n      history({\r\n        initialEntries: [url],\r\n      })\r\n    );\r\n\r\n    // dispatch any global and non-saga related actions before calling our JSX\r\n    const versionStatusFromHostname = deliveryApi.getVersionStatusFromHostname(\r\n      request.hostname\r\n    );\r\n\r\n    console.info(\r\n      `Request for ${request.path} hostname: ${request.hostname} versionStatus: ${versionStatusFromHostname}`\r\n    );\r\n\r\n    store.dispatch(\r\n      setVersionStatus(request.query.versionStatus || versionStatusFromHostname)\r\n    );\r\n    store.dispatch(setVersion(versionInfo.commitRef, versionInfo.buildNo));\r\n\r\n    const project = pickProject(request.hostname, request.query);\r\n\r\n    const groups = allowedGroups && allowedGroups[project];\r\n    store.dispatch(setCurrentProject(project, groups, request.hostname));\r\n\r\n    const modules = [];\r\n\r\n    const jsx = (\r\n      <Loadable.Capture report={moduleName => modules.push(moduleName)}>\r\n        <ReduxProvider store={store}>\r\n          <StaticRouter context={context} location={url}>\r\n            <ReactApp routes={routes} withEvents={withEvents} />\r\n          </StaticRouter>\r\n        </ReduxProvider>\r\n      </Loadable.Capture>\r\n    );\r\n\r\n    const buildBundleTags = bundles => {\r\n      // Take the bundles returned from Loadable.Capture\r\n      const bundleTags = bundles\r\n        .map(bundle => {\r\n          if (bundle.publicPath.includes('/modern/'))\r\n            return differentialBundles\r\n              ? `<script type=\"module\" src=\"${replaceStaticPath(\r\n                  bundle.publicPath,\r\n                  staticRoutePath\r\n                )}\"></script>`\r\n              : null;\r\n          return `<script nomodule src=\"${replaceStaticPath(\r\n            bundle.publicPath,\r\n            staticRoutePath\r\n          )}\"></script>`;\r\n        })\r\n        .filter(f => f);\r\n\r\n      // Add the static startup script to the bundleTags\r\n      startupScriptFilename &&\r\n        bundleTags.push(\r\n          `<script src=\"/${staticRoutePath}/${startupScriptFilename}\"></script>`\r\n        );\r\n\r\n      return bundleTags;\r\n    };\r\n\r\n    const templates =\r\n      bundleData.default.templates || bundleData.legacy.templates;\r\n\r\n    const stats =\r\n      bundleData.modern.stats && bundleData.legacy.stats\r\n        ? fromEntries(\r\n            Object.entries(bundleData.modern.stats).map(([lib, paths]) => [\r\n              lib,\r\n              bundleData.legacy.stats[lib]\r\n                ? [...paths, ...bundleData.legacy.stats[lib]]\r\n                : paths,\r\n            ])\r\n          )\r\n        : bundleData.default.stats;\r\n\r\n    const {\r\n      templateHTML,\r\n      templateHTMLFragment,\r\n      templateHTMLStatic,\r\n    } = templates;\r\n\r\n    // Serve a blank HTML page with client scripts to load the app in the browser\r\n    if (accessMethod.DYNAMIC) {\r\n      // Dynamic doesn't need sagas\r\n      renderToString(jsx);\r\n\r\n      // Dynamic page render has only the necessary bundles to start up the app\r\n      // and does not include any react-loadable code-split bundles\r\n      const loadableBundles = getBundles(stats, modules);\r\n      const bundleTags = buildBundleTags(loadableBundles).join('');\r\n\r\n      const isDynamicHint = `<script>window.isDynamic = true;</script>`;\r\n\r\n      const responseHtmlDynamic = templateHTML\r\n        .replace('{{TITLE}}', '')\r\n        .replace('{{SEO_CRITICAL_METADATA}}', '')\r\n        .replace('{{CRITICAL_CSS}}', '')\r\n        .replace('{{APP}}', '')\r\n        .replace('{{LOADABLE_CHUNKS}}', bundleTags)\r\n        .replace('{{REDUX_DATA}}', isDynamicHint);\r\n      // Dynamic pages always return a 200 so we can run\r\n      // the app and serve up all errors inside the client\r\n      response.setHeader(\r\n        'Surrogate-Control',\r\n        `max-age=${getCacheDuration(200)}`\r\n      );\r\n      responseHandler(request, response, responseHtmlDynamic);\r\n    }\r\n\r\n    // Render the JSX server side and send response as per access method options\r\n    if (!accessMethod.DYNAMIC) {\r\n      store\r\n        .runSaga(rootSaga(withSagas))\r\n        .toPromise()\r\n        .then(() => {\r\n          const sheet = new ServerStyleSheet();\r\n\r\n          const html = renderToString(sheet.collectStyles(jsx));\r\n\r\n          const helmet = Helmet.renderStatic();\r\n          Helmet.rewind();\r\n          const htmlAttributes = helmet.htmlAttributes.toString();\r\n          let title = helmet.title.toString();\r\n          const metadata = helmet.meta.toString();\r\n\r\n          if (context.url) {\r\n            return response.redirect(302, context.url);\r\n          }\r\n\r\n          const reduxState = store.getState();\r\n\r\n          const styleTags = sheet.getStyleTags();\r\n\r\n          // After running rootSaga there should be an additional react-loadable\r\n          // code-split bundle for a page component as well as core app bundles\r\n          const loadableBundles = getBundles(stats, modules);\r\n          const bundleTags = buildBundleTags(loadableBundles).join('');\r\n\r\n          let serialisedReduxData = '';\r\n          if (context.status !== 404) {\r\n            // For a request that returns a redux state object as a response\r\n            if (accessMethod.REDUX) {\r\n              serialisedReduxData = serialize(reduxState, {\r\n                ignoreFunction: true,\r\n              });\r\n              addStandardHeaders(reduxState, response, packagejson, {\r\n                allowedGroups,\r\n                globalGroups,\r\n              });\r\n              responseHandler(request, response, serialisedReduxData, 'json');\r\n              return true;\r\n            }\r\n            if (!disableSsrRedux) {\r\n              serialisedReduxData = serialize(reduxState, {\r\n                ignoreFunction: true,\r\n              });\r\n              serialisedReduxData = `<script>window.REDUX_DATA = ${serialisedReduxData}</script>`;\r\n            }\r\n          }\r\n          if (context.status > 400) {\r\n            accessMethod.STATIC = true;\r\n          }\r\n\r\n          // Responses\r\n          let responseHTML = '';\r\n\r\n          if (context.status === 404)\r\n            title = '<title>404 page not found</title>';\r\n\r\n          // Static page served as a fragment\r\n          if (accessMethod.FRAGMENT && accessMethod.STATIC) {\r\n            responseHTML = minifyCssString(styleTags) + html;\r\n          }\r\n\r\n          // Page fragment served with client scripts and redux data that hydrate the app client side\r\n          if (accessMethod.FRAGMENT && !accessMethod.STATIC) {\r\n            responseHTML = templateHTMLFragment\r\n              .replace('{{TITLE}}', title)\r\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\r\n              .replace('{{CRITICAL_CSS}}', minifyCssString(styleTags))\r\n              .replace('{{APP}}', html)\r\n              .replace('{{LOADABLE_CHUNKS}}', bundleTags)\r\n              .replace('{{REDUX_DATA}}', serialisedReduxData);\r\n          }\r\n\r\n          // Full HTML page served statically\r\n          if (!accessMethod.FRAGMENT && accessMethod.STATIC) {\r\n            responseHTML = templateHTMLStatic\r\n              .replace('{{TITLE}}', title)\r\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\r\n              .replace('{{CRITICAL_CSS}}', minifyCssString(styleTags))\r\n              .replace('{{APP}}', html)\r\n              .replace('{{LOADABLE_CHUNKS}}', '');\r\n          }\r\n\r\n          // Full HTML page served with client scripts and redux data that hydrate the app client side\r\n          if (!accessMethod.FRAGMENT && !accessMethod.STATIC) {\r\n            responseHTML = templateHTML\r\n              .replace('{{TITLE}}', title)\r\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\r\n              .replace('{{CRITICAL_CSS}}', styleTags)\r\n              .replace('{{APP}}', html)\r\n              .replace('{{LOADABLE_CHUNKS}}', bundleTags)\r\n              .replace('{{REDUX_DATA}}', serialisedReduxData);\r\n          }\r\n\r\n          // Set response.status from React StaticRouter\r\n          if (typeof context.status === 'number')\r\n            response.status(context.status);\r\n\r\n          addStandardHeaders(reduxState, response, packagejson, {\r\n            allowedGroups,\r\n            globalGroups,\r\n          });\r\n          try {\r\n            // If react-helmet htmlAttributes are being used,\r\n            // replace the html tag with those attributes sepcified\r\n            // e.g. (lang, dir etc.)\r\n            if (htmlAttributes) {\r\n              responseHTML = responseHTML.replace(\r\n                /<html?.+?>/,\r\n                `<html ${htmlAttributes}>`\r\n              );\r\n            }\r\n            responseHandler(request, response, responseHTML);\r\n          } catch (err) {\r\n            console.info(err.message);\r\n          }\r\n        })\r\n        .catch(err => {\r\n          // Handle any error that occurred in any of the previous\r\n          // promises in the chain.\r\n          console.info(err);\r\n          response.status(500);\r\n          responseHandler(\r\n            request,\r\n            response,\r\n            `Error occurred: <br />${err.stack} <br />${JSON.stringify(err)}`\r\n          );\r\n        });\r\n      renderToString(jsx);\r\n\r\n      store.close();\r\n    }\r\n  });\r\n};\r\n\r\nexport default webApp;\r\n","import 'isomorphic-fetch';\r\nimport express from 'express';\r\nimport Loadable from 'react-loadable';\r\n\r\nimport DisplayStartupConfiguration from './util/displayStartupConfiguration';\r\nimport ConfigureReverseProxies, { apiProxy } from './core/reverseProxies';\r\nimport ServeStaticAssets from './core/staticAssets';\r\nimport ConfigureWebApp from './core/webApp';\r\n\r\nconst app = express();\r\n\r\nconst start = (ReactApp, config, ServerFeatures) => {\r\n  global.PACKAGE_JSON = config.packagejson;\r\n  global.REVERSE_PROXY_PATHS = Object(config.reverseProxyPaths);\r\n  global.PROXY_DELIVERY_API = config.proxyDeliveryApi;\r\n  global.DISABLE_SSR_REDUX = config.disableSsrRedux;\r\n\r\n  app.disable('x-powered-by');\r\n\r\n  // Output some information about the used build/startup configuration\r\n  DisplayStartupConfiguration(config);\r\n\r\n  ServerFeatures(app);\r\n  // Set-up local proxy for images from cms, and delivery api requests\r\n  // to save doing rewrites and extra code\r\n  ConfigureReverseProxies(app, config.reverseProxyPaths);\r\n  ServeStaticAssets(app, config);\r\n  ConfigureWebApp(app, ReactApp, config);\r\n\r\n  app.on('ready', async () => {\r\n    // Configure DNS to make life easier\r\n    //await ConfigureLocalDNS();\r\n\r\n    Loadable.preloadAll().then(() => {\r\n      var server = app.listen(3001, () => {\r\n        console.info(`HTTP server is listening @ port 3001`);\r\n        setTimeout(function() {\r\n          app.emit('app_started');\r\n        }, 500);\r\n      });\r\n      app.on('stop', () => {\r\n        server.close(function() {\r\n          console.info('GoodBye :(');\r\n        });\r\n      });\r\n    });\r\n  });\r\n};\r\n\r\nexport default { app, apiProxy, start };\r\n"],"names":["servers","SERVERS","projects","PROJECTS","DisplayStartupConfiguration","config","console","log","JSON","stringify","reverseProxyPaths","apiProxy","httpProxy","createProxyServer","reverseProxies","app","deliveryApiProxy","all","req","res","target","hostname","indexOf","previewIis","iis","web","changeOrigin","on","e","path","cms","alias","CacheDuration","static","expressStatic","getCacheDuration","status","replaceStaticPath","string","staticFolderPath","replace","bundleManipulationMiddleware","appRootPath","maxage","staticRoutePath","next","filename","basename","modernBundle","endsWith","legacyBundle","startsWith","jsRuntimeLocation","resolve","jsRuntimeBundle","fs","readFileSync","modifiedBundle","set","type","send","readError","resolveStartupMiddleware","startupScriptFilename","startupFilePath","startupFileLocation","sendFile","sendFileError","staticAssets","require","staticRoutePaths","use","map","p","express","ResponseMethod","json","end","handleResponse","request","response","content","addStandardHeaders","state","packagejson","groups","info","routingSurrogateKeys","getIn","surrogateKeyHeader","name","header","addVarnishAuthenticationHeaders","setHeader","statusCode","message","stateEntry","selectRouteEntry","project","selectCurrentProject","globalGroups","allowedGroups","allGroups","Array","from","join","loadableBundleData","stats","templates","build","bundle","parse","ex","templateHTML","html","templateHTMLStatic","templateHTMLFragment","fragment","webApp","ReactApp","routes","withReducers","withSagas","withEvents","differentialBundles","disableSsrRedux","handleResponses","bundleData","default","legacy","modern","responseHandler","versionInfo","get","url","matchedStaticRoute","matchRoutes","StaticRoutes","isStaticRoute","length","staticRoute","onlyDynamic","route","ssr","onlySSR","ssrOnly","normaliseQs","q","toLowerCase","accessMethod","mapJson","query","DYNAMIC","dynamic","REDUX","redux","FRAGMENT","STATIC","value","context","store","createStore","fromJS","history","initialEntries","versionStatusFromHostname","deliveryApi","getVersionStatusFromHostname","dispatch","setVersionStatus","versionStatus","setVersion","commitRef","buildNo","pickProject","setCurrentProject","modules","jsx","moduleName","push","ReduxProvider","buildBundleTags","bundles","bundleTags","publicPath","includes","filter","f","fromEntries","Object","entries","lib","paths","renderToString","loadableBundles","getBundles","isDynamicHint","responseHtmlDynamic","runSaga","rootSaga","toPromise","then","sheet","ServerStyleSheet","collectStyles","helmet","Helmet","renderStatic","rewind","htmlAttributes","toString","title","metadata","meta","redirect","reduxState","getState","styleTags","getStyleTags","serialisedReduxData","serialize","ignoreFunction","responseHTML","minifyCssString","err","catch","stack","close","start","ServerFeatures","global","PACKAGE_JSON","REVERSE_PROXY_PATHS","PROXY_DELIVERY_API","proxyDeliveryApi","DISABLE_SSR_REDUX","disable","ConfigureReverseProxies","ServeStaticAssets","ConfigureWebApp","Loadable","preloadAll","server","listen","setTimeout","emit"],"mappings":"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"}
>>>>>>> contensis-14-forgot-change-password
