<<<<<<< HEAD
{"version":3,"file":"contensis-react-base.js","sources":["../src/server/util/displayStartupConfiguration.js","../src/server/core/reverseProxies.js","../src/server/util/types.js","../src/server/util/handleResponse.js","../src/server/core/webApp.js","../src/server/internalServer.js"],"sourcesContent":["const servers = SERVERS; /* global SERVERS */\r\nconst projects = PROJECTS; /* global PROJECTS */\r\n\r\nconst DisplayStartupConfiguration = config => {\r\n  /* eslint-disable no-console */\r\n  console.log();\r\n  console.log(\r\n    `Configured servers:\r\n`,\r\n    JSON.stringify(servers, null, 2)\r\n  );\r\n  console.log();\r\n  console.log(\r\n    `Configured projects:\r\n`,\r\n    JSON.stringify(projects, null, 2)\r\n  );\r\n  console.log();\r\n  console.log(\r\n    'Reverse proxy paths: ',\r\n    JSON.stringify(config.reverseProxyPaths, null, 2)\r\n  );\r\n  console.log();\r\n\r\n  /* eslint-enable no-console */\r\n};\r\n\r\nexport default DisplayStartupConfiguration;\r\n","import httpProxy from 'http-proxy';\r\n\r\nconst servers = SERVERS; /* global SERVERS */\r\nexport const apiProxy = httpProxy.createProxyServer();\r\n\r\nconst reverseProxies = (app, reverseProxyPaths) => {\r\n  deliveryApiProxy(apiProxy, app);\r\n\r\n  app.all(reverseProxyPaths, (req, res) => {\r\n    const target =\r\n      req.hostname.indexOf('preview-') ||\r\n      req.hostname.indexOf('preview.') ||\r\n      req.hostname === 'localhost'\r\n        ? servers.previewIis || servers.iis\r\n        : servers.iis;\r\n\r\n    apiProxy.web(req, res, { target, changeOrigin: true });\r\n    apiProxy.on('error', e => {\r\n      /* eslint-disable no-console */\r\n      console.log(\r\n        `Proxy Request for ${req.path} HostName:${req.hostname} failed with ${e}`\r\n      );\r\n      /* eslint-enable no-console */\r\n    });\r\n  });\r\n};\r\n\r\nconst deliveryApiProxy = (apiProxy, app) => {\r\n  // This is just here to stop cors requests on localhost. In Production this is mapped using varnish.\r\n  app.all(['/api/delivery/*', '/api/image/*'], (req, res) => {\r\n    /* eslint-disable no-console */\r\n    const target = servers.cms;\r\n    console.log(`Proxying api request to ${servers.alias}`);\r\n    apiProxy.web(req, res, {\r\n      target,\r\n      changeOrigin: true,\r\n    });\r\n    apiProxy.on('error', e => {\r\n      /* eslint-disable no-console */\r\n      console.log(\r\n        `Proxy request for ${req.path} HostName:${req.hostname} failed with ${e}`\r\n      );\r\n      /* eslint-enable no-console */\r\n    });\r\n  });\r\n};\r\n\r\nexport default reverseProxies;\r\n","export const AccessMethods = {\r\n  DYNAMIC: 'dynamic',\r\n  STATIC: 'static',\r\n  FRAGMENT: 'fragment',\r\n  REDUX: 'redux',\r\n};\r\n\r\nexport const ResponseMethod = {\r\n  send: 'send',\r\n  json: 'json',\r\n  end: 'end',\r\n};\r\n","/* eslint-disable no-console */\r\nimport { ResponseMethod } from './types';\r\n\r\n/**\r\n * Web Application Response handler, sends a prepared express js response\r\n * with the supplied content sending in the specified manner\r\n * @param {response} request express js request object\r\n * @param {response} response express js response object\r\n * @param {string | object} content the content to send in the response body\r\n * @param {function} send the response function to call e.g res.send() res.json() res.end()\r\n */\r\nconst handleResponse = (\r\n  request,\r\n  response,\r\n  content,\r\n  send = ResponseMethod.send\r\n) => {\r\n  // console.log('---', response.statusCode, '---');\r\n  response[send](content);\r\n};\r\n\r\nexport default handleResponse;\r\n","import fs from 'fs';\r\nimport React from 'react';\r\nimport { StaticRouter } from 'react-router-dom';\r\nimport { Provider as ReduxProvider } from 'react-redux';\r\nimport Loadable from 'react-loadable';\r\nimport { renderToString } from 'react-dom/server';\r\nimport { getBundles } from 'react-loadable/webpack';\r\nimport { ServerStyleSheet } from 'styled-components';\r\nimport Helmet from 'react-helmet';\r\nimport serialize from 'serialize-javascript';\r\nimport minifyCssString from 'minify-css-string';\r\nimport { fromJS } from 'immutable';\r\nimport fromEntries from 'fromentries';\r\n\r\nimport { history } from '~/core/redux/history';\r\n\r\nimport { AccessMethods } from '../util/types';\r\nimport handleResponse from '../util/handleResponse';\r\n\r\nimport pickProject from '~/core/util/pickProject';\r\nimport { deliveryApi } from '~/core/util/ContensisDeliveryApi';\r\n\r\nimport { setCurrentProject } from '~/core/redux/actions/routing';\r\nimport { setVersion, setVersionStatus } from '~/core/redux/actions/version';\r\n\r\nimport {\r\n  selectCurrentProject,\r\n  selectRouteEntry,\r\n} from '~/core/redux/selectors/routing';\r\n\r\nimport createStore from '~/core/redux/store';\r\nimport rootSaga from '~/core/redux/sagas/index.js';\r\nimport { matchRoutes } from 'react-router-config';\r\n\r\nconst addStandardHeaders = (state, response, packagejson, groups) => {\r\n  if (state) {\r\n    /* eslint-disable no-console */\r\n    try {\r\n      console.log('About to add headers');\r\n      const routingSurrogateKeys = state.getIn(\r\n        ['routing', 'surrogateKeys'],\r\n        ''\r\n      );\r\n\r\n      const surrogateKeyHeader = ` ${packagejson.name}-app ${routingSurrogateKeys}`;\r\n\r\n      response.header('surrogate-key', surrogateKeyHeader);\r\n\r\n      addVarnishAuthenticationHeaders(state, response, groups);\r\n\r\n      response.setHeader('Surrogate-Control', 'max-age=3600');\r\n    } catch (e) {\r\n      console.log('Error Adding headers', e.message);\r\n      // console.log(e);\r\n    }\r\n  }\r\n};\r\n\r\nconst addVarnishAuthenticationHeaders = (state, response, groups = {}) => {\r\n  if (state) {\r\n    try {\r\n      const stateEntry = selectRouteEntry(state);\r\n      const project = selectCurrentProject(state);\r\n      const { globalGroups, allowedGroups } = groups;\r\n      // console.log(globalGroups, allowedGroups);\r\n      let allGroups = Array.from((globalGroups && globalGroups[project]) || {});\r\n      if (\r\n        stateEntry &&\r\n        stateEntry.getIn(['authentication', 'isLoginRequired']) &&\r\n        allowedGroups &&\r\n        allowedGroups[project]\r\n      ) {\r\n        allGroups = [...allGroups, ...allowedGroups[project]];\r\n      }\r\n      response.header('x-contensis-viewer-groups', allGroups.join('|'));\r\n    } catch (e) {\r\n      console.log('Error adding authentication header');\r\n      console.log(e);\r\n    }\r\n  }\r\n};\r\n\r\nconst readFileSync = path => fs.readFileSync(path, 'utf8');\r\n\r\nconst loadBundleData = ({ stats, templates }, build) => {\r\n  const bundle = {};\r\n  try {\r\n    bundle.stats = JSON.parse(\r\n      readFileSync(stats.replace('/target', build ? `/${build}` : ''))\r\n    );\r\n  } catch (ex) {\r\n    //console.log(ex);\r\n    bundle.stats = null;\r\n  }\r\n  try {\r\n    bundle.templates = {\r\n      templateHTML: readFileSync(\r\n        templates.html.replace('/target', build ? `/${build}` : '')\r\n      ),\r\n      templateHTMLStatic: readFileSync(\r\n        templates.static.replace('/target', build ? `/${build}` : '')\r\n      ),\r\n      templateHTMLFragment: readFileSync(\r\n        templates.fragment.replace('/target', build ? `/${build}` : '')\r\n      ),\r\n    };\r\n  } catch (ex) {\r\n    //console.log(ex);\r\n    bundle.templates = null;\r\n  }\r\n  return bundle;\r\n};\r\n\r\nconst webApp = (app, ReactApp, config) => {\r\n  const {\r\n    routes,\r\n    withReducers,\r\n    withSagas,\r\n    withEvents,\r\n    packagejson,\r\n    versionData,\r\n    differentialBundles,\r\n    dynamicPaths,\r\n    allowedGroups,\r\n    globalGroups,\r\n    disableSsrRedux,\r\n    handleResponses,\r\n  } = config;\r\n\r\n  const bundles = {\r\n    default: loadBundleData(config),\r\n    legacy: loadBundleData(config, 'legacy'),\r\n    modern: loadBundleData(config, 'modern'),\r\n  };\r\n  if (!bundles.default || bundles.default === {})\r\n    bundles.default = bundles.legacy || bundles.modern;\r\n\r\n  const versionInfo = JSON.parse(fs.readFileSync(versionData, 'utf8'));\r\n\r\n  const responseHandler =\r\n    typeof handleResponses === 'function' ? handleResponses : handleResponse;\r\n\r\n  app.get('/*', (request, response, next) => {\r\n    if (request.originalUrl.startsWith('/static/')) return next();\r\n    const { url } = request;\r\n\r\n    const matchedStaticRoute = () =>\r\n      matchRoutes(routes.StaticRoutes, request.path);\r\n    const isStaticRoute = () => matchedStaticRoute().length > 0;\r\n    const staticRoute = isStaticRoute() && matchedStaticRoute()[0];\r\n\r\n    // Determine functional params and set access methods\r\n    let accessMethod = {};\r\n\r\n    const isDynamicNormalised = request.query.dynamic\r\n      ? request.query.dynamic.toLowerCase()\r\n      : 'false';\r\n\r\n    // Hack for certain pages to avoid SSR\r\n    const onlyDynamic =\r\n      dynamicPaths.includes(request.path) ||\r\n      (staticRoute && staticRoute.route.ssr === false);\r\n\r\n    const isReduxRequestNormalised = request.query.redux\r\n      ? request.query.redux.toLowerCase()\r\n      : 'false';\r\n\r\n    const isFragmentNormalised = request.query.fragment\r\n      ? request.query.fragment.toLowerCase()\r\n      : 'false';\r\n\r\n    const isStaticNormalised = request.query.static\r\n      ? request.query.static.toLowerCase()\r\n      : 'false';\r\n\r\n    if (onlyDynamic || isDynamicNormalised === 'true')\r\n      accessMethod.DYNAMIC = AccessMethods.DYNAMIC;\r\n    if (isReduxRequestNormalised === 'true')\r\n      accessMethod.REDUX = AccessMethods.REDUX;\r\n    if (isFragmentNormalised === 'true')\r\n      accessMethod.FRAGMENT = AccessMethods.FRAGMENT;\r\n    if (isStaticNormalised === 'true')\r\n      accessMethod.STATIC = AccessMethods.STATIC;\r\n\r\n    const context = {};\r\n    let status = 200;\r\n\r\n    // Create a store (with a memory history) from our current url\r\n    const store = createStore(\r\n      withReducers,\r\n      fromJS({}),\r\n      history({ initialEntries: [url] })\r\n    );\r\n    //const store = createStore(withReducers);\r\n\r\n    // dispatch any global and non-saga related actions before calling our JSX\r\n    const versionStatusFromHostname = deliveryApi.getVersionStatusFromHostname(\r\n      request.hostname\r\n    );\r\n\r\n    store.dispatch(\r\n      setVersionStatus(request.query.versionStatus || versionStatusFromHostname)\r\n    );\r\n    store.dispatch(setVersion(versionInfo.commitRef, versionInfo.buildNo));\r\n\r\n    const project = pickProject(request.hostname, request.query);\r\n\r\n    const groups = allowedGroups && allowedGroups[project];\r\n    store.dispatch(setCurrentProject(project, groups));\r\n\r\n    const modules = [];\r\n\r\n    const jsx = (\r\n      <Loadable.Capture report={moduleName => modules.push(moduleName)}>\r\n        <ReduxProvider store={store}>\r\n          <StaticRouter context={context} location={url}>\r\n            <ReactApp routes={routes} withEvents={withEvents} />\r\n          </StaticRouter>\r\n        </ReduxProvider>\r\n      </Loadable.Capture>\r\n    );\r\n\r\n    /* eslint-disable no-console */\r\n    console.log(\r\n      `Request for ${request.path} hostname: ${request.hostname} versionStatus: ${versionStatusFromHostname}`\r\n    );\r\n    /* eslint-enable no-console */\r\n\r\n    const templates = bundles.default.templates || bundles.legacy.templates;\r\n    const stats =\r\n      bundles.modern.stats && bundles.legacy.stats\r\n        ? fromEntries(\r\n            Object.entries(bundles.modern.stats).map(([lib, paths]) => [\r\n              lib,\r\n              bundles.legacy.stats[lib]\r\n                ? [...paths, ...bundles.legacy.stats[lib]]\r\n                : paths,\r\n            ])\r\n          )\r\n        : bundles.default.stats;\r\n\r\n    const {\r\n      templateHTML,\r\n      templateHTMLFragment,\r\n      templateHTMLStatic,\r\n    } = templates;\r\n\r\n    // Serve a blank HTML page with client scripts to load the app in the browser\r\n    if (accessMethod.DYNAMIC) {\r\n      // Dynamic doesn't need sagas\r\n      renderToString(jsx);\r\n\r\n      const isDynamicHint = `<script>window.isDynamic = true;</script>`;\r\n      const dynamicBundles = getBundles(stats, modules);\r\n      const dynamicBundleScripts = dynamicBundles\r\n        .map(bundle => {\r\n          if (bundle.publicPath.includes('/modern/'))\r\n            return differentialBundles\r\n              ? `<script type=\"module\" src=\"${bundle.publicPath}\"></script>`\r\n              : null;\r\n          return `<script nomodule src=\"${bundle.publicPath}\"></script>`;\r\n        })\r\n        .filter(f => f)\r\n        .join('');\r\n      const responseHtmlDynamic = templateHTML\r\n        .replace('{{TITLE}}', '')\r\n        .replace('{{SEO_CRITICAL_METADATA}}', '')\r\n        .replace('{{CRITICAL_CSS}}', '')\r\n        .replace('{{APP}}', '')\r\n        .replace('{{LOADABLE_CHUNKS}}', dynamicBundleScripts)\r\n        .replace('{{REDUX_DATA}}', isDynamicHint);\r\n      response.setHeader('Surrogate-Control', 'max-age=3600');\r\n      response.status(status); //.send(responseHtmlDynamic);\r\n      responseHandler(request, response, responseHtmlDynamic);\r\n    }\r\n\r\n    // Render the JSX server side and send response as per access method options\r\n    if (!accessMethod.DYNAMIC) {\r\n      store\r\n        .runSaga(rootSaga(withSagas))\r\n        .toPromise()\r\n        .then(() => {\r\n          const sheet = new ServerStyleSheet();\r\n\r\n          const html = renderToString(sheet.collectStyles(jsx));\r\n\r\n          const helmet = Helmet.renderStatic();\r\n          Helmet.rewind();\r\n          let title = helmet.title.toString();\r\n          const metadata = helmet.meta.toString();\r\n\r\n          if (context.status === 404) {\r\n            status = 404;\r\n            title = '<title>404 page not found</title>';\r\n          }\r\n\r\n          if (context.url) {\r\n            return response.redirect(302, context.url);\r\n          }\r\n\r\n          const reduxState = store.getState();\r\n\r\n          const styleTags = sheet.getStyleTags();\r\n\r\n          const bundles = getBundles(stats, modules);\r\n\r\n          const bundleScripts = bundles\r\n            .map(bundle => {\r\n              if (bundle.publicPath.includes('/modern/'))\r\n                return differentialBundles\r\n                  ? `<script type=\"module\" src=\"${bundle.publicPath}\"></script>`\r\n                  : null;\r\n              return `<script nomodule src=\"${bundle.publicPath}\"></script>`;\r\n            })\r\n            .filter(f => f)\r\n            .join('');\r\n\r\n          let serialisedReduxData = '';\r\n          if (context.status !== 404) {\r\n            if (accessMethod.REDUX) {\r\n              serialisedReduxData = serialize(reduxState, {\r\n                ignoreFunction: true,\r\n              });\r\n              addStandardHeaders(reduxState, response, packagejson, {\r\n                allowedGroups,\r\n                globalGroups,\r\n              });\r\n              response.status(status); //.json(serialisedReduxData);\r\n              responseHandler(request, response, serialisedReduxData, 'json');\r\n              return true;\r\n            }\r\n            if (!disableSsrRedux) {\r\n              serialisedReduxData = serialize(reduxState, {\r\n                ignoreFunction: true,\r\n              });\r\n              serialisedReduxData = `<script>window.REDUX_DATA = ${serialisedReduxData}</script>`;\r\n            }\r\n          }\r\n          if (context.status === 404) {\r\n            accessMethod.STATIC = AccessMethods.STATIC;\r\n          }\r\n\r\n          // Responses\r\n          let responseHTML = '';\r\n\r\n          // Static page served as a fragment\r\n          if (accessMethod.FRAGMENT && accessMethod.STATIC) {\r\n            addStandardHeaders(reduxState, response, packagejson, {\r\n              allowedGroups,\r\n              globalGroups,\r\n            });\r\n            responseHTML = minifyCssString(styleTags) + html;\r\n          }\r\n\r\n          // Page fragment served with client scripts and redux data that hydrate the app client side\r\n          if (accessMethod.FRAGMENT && !accessMethod.STATIC) {\r\n            responseHTML = templateHTMLFragment\r\n              .replace('{{TITLE}}', title)\r\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\r\n              .replace('{{CRITICAL_CSS}}', minifyCssString(styleTags))\r\n              .replace('{{APP}}', html)\r\n              .replace('{{LOADABLE_CHUNKS}}', bundleScripts)\r\n              .replace('{{REDUX_DATA}}', serialisedReduxData);\r\n          }\r\n\r\n          // Full HTML page served statically\r\n          if (!accessMethod.FRAGMENT && accessMethod.STATIC) {\r\n            responseHTML = templateHTMLStatic\r\n              .replace('{{TITLE}}', title)\r\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\r\n              .replace('{{CRITICAL_CSS}}', minifyCssString(styleTags))\r\n              .replace('{{APP}}', html)\r\n              .replace('{{LOADABLE_CHUNKS}}', '');\r\n          }\r\n\r\n          // Full HTML page served with client scripts and redux data that hydrate the app client side\r\n          if (!accessMethod.FRAGMENT && !accessMethod.STATIC) {\r\n            responseHTML = templateHTML\r\n              .replace('{{TITLE}}', title)\r\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\r\n              .replace('{{CRITICAL_CSS}}', styleTags)\r\n              .replace('{{APP}}', html)\r\n              .replace('{{LOADABLE_CHUNKS}}', bundleScripts)\r\n              .replace('{{REDUX_DATA}}', serialisedReduxData);\r\n          }\r\n          addStandardHeaders(reduxState, response, packagejson, {\r\n            allowedGroups,\r\n            globalGroups,\r\n          });\r\n          try {\r\n            response.status(status); //.send(responseHTML);\r\n            responseHandler(request, response, responseHTML);\r\n          } catch (err) {\r\n            // eslint-disable-next-line no-console\r\n            console.log(err.message);\r\n          }\r\n        })\r\n        .catch(err => {\r\n          // Handle any error that occurred in any of the previous\r\n          // promises in the chain.\r\n          /* eslint-disable no-console */\r\n          console.log(err);\r\n          /* eslint-enable no-console */\r\n          response.status(500);\r\n          responseHandler(\r\n            request,\r\n            response,\r\n            `Error occurred: <br />${err.stack} <br />${JSON.stringify(err)}`\r\n          );\r\n          // .send(\r\n          //   `Error occurred: <br />${err.stack} <br />${JSON.stringify(err)}`\r\n          // );\r\n        });\r\n      renderToString(jsx);\r\n\r\n      store.close();\r\n    }\r\n  });\r\n};\r\n\r\nexport default webApp;\r\n","import 'isomorphic-fetch';\r\nimport express from 'express';\r\nimport Loadable from 'react-loadable';\r\n\r\nimport DisplayStartupConfiguration from './util/displayStartupConfiguration';\r\nimport ConfigureReverseProxies, { apiProxy } from './core/reverseProxies';\r\nimport ConfigureWebApp from './core/webApp';\r\n\r\nconst app = express();\r\n\r\nconst start = (ReactApp, config, ServerFeatures) => {\r\n  app.disable('x-powered-by');\r\n\r\n  // Output some information about the used build/startup configuration\r\n  DisplayStartupConfiguration(config);\r\n\r\n  // Set-up local proxy for images from cms, to save doing rewrites and extra code\r\n  ServerFeatures(app);\r\n  ConfigureReverseProxies(app, config.reverseProxyPaths);\r\n  ConfigureWebApp(app, ReactApp, config);\r\n\r\n  app.use('/static', express.static('dist/static', { maxage: '31557600h' }));\r\n\r\n  app.on('ready', async () => {\r\n    // Configure DNS to make life easier\r\n    //await ConfigureLocalDNS();\r\n\r\n    Loadable.preloadAll().then(() => {\r\n      var server = app.listen(3001, () => {\r\n        console.info(`HTTP server is listening @ port 3001`);\r\n        setTimeout(function() {\r\n          app.emit('app_started');\r\n        }, 500);\r\n      });\r\n      app.on('stop', () => {\r\n        server.close(function() {\r\n          console.info('GoodBye :(');\r\n        });\r\n      });\r\n    });\r\n  });\r\n};\r\n\r\nexport default { app, apiProxy, start };\r\n"],"names":["servers","SERVERS","projects","PROJECTS","DisplayStartupConfiguration","config","console","log","JSON","stringify","reverseProxyPaths","apiProxy","httpProxy","createProxyServer","reverseProxies","app","deliveryApiProxy","all","req","res","target","hostname","indexOf","previewIis","iis","web","changeOrigin","on","e","path","cms","alias","AccessMethods","DYNAMIC","STATIC","FRAGMENT","REDUX","ResponseMethod","send","json","end","handleResponse","request","response","content","addStandardHeaders","state","packagejson","groups","routingSurrogateKeys","getIn","surrogateKeyHeader","name","header","addVarnishAuthenticationHeaders","setHeader","message","stateEntry","selectRouteEntry","project","selectCurrentProject","globalGroups","allowedGroups","allGroups","Array","from","join","readFileSync","fs","loadBundleData","stats","templates","build","bundle","parse","replace","ex","templateHTML","html","templateHTMLStatic","static","templateHTMLFragment","fragment","webApp","ReactApp","routes","withReducers","withSagas","withEvents","versionData","differentialBundles","dynamicPaths","disableSsrRedux","handleResponses","bundles","default","legacy","modern","versionInfo","responseHandler","get","next","originalUrl","startsWith","url","matchedStaticRoute","matchRoutes","StaticRoutes","isStaticRoute","length","staticRoute","accessMethod","isDynamicNormalised","query","dynamic","toLowerCase","onlyDynamic","includes","route","ssr","isReduxRequestNormalised","redux","isFragmentNormalised","isStaticNormalised","context","status","store","createStore","fromJS","history","initialEntries","versionStatusFromHostname","deliveryApi","getVersionStatusFromHostname","dispatch","setVersionStatus","versionStatus","setVersion","commitRef","buildNo","pickProject","setCurrentProject","modules","jsx","moduleName","push","ReduxProvider","fromEntries","Object","entries","map","lib","paths","renderToString","isDynamicHint","dynamicBundles","getBundles","dynamicBundleScripts","publicPath","filter","f","responseHtmlDynamic","runSaga","rootSaga","toPromise","then","sheet","ServerStyleSheet","collectStyles","helmet","Helmet","renderStatic","rewind","title","toString","metadata","meta","redirect","reduxState","getState","styleTags","getStyleTags","bundleScripts","serialisedReduxData","serialize","ignoreFunction","responseHTML","minifyCssString","err","catch","stack","close","express","start","ServerFeatures","disable","ConfigureReverseProxies","ConfigureWebApp","use","maxage","Loadable","preloadAll","server","listen","info","setTimeout","emit"],"mappings":"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"}
=======
{"version":3,"file":"contensis-react-base.js","sources":["../src/server/util/displayStartupConfiguration.js","../src/server/util/fetchMyIp.js","../src/server/core/localDns.js","../src/server/core/reverseProxies.js","../src/server/util/types.js","../src/server/util/handleResponse.js","../src/server/util/cacheHashing.js","../src/server/core/webApp.js","../src/server/internalServer.js"],"sourcesContent":["const servers = SERVERS; /* global SERVERS */\nconst projects = PROJECTS; /* global PROJECTS */\n\nconst DisplayStartupConfiguration = config => {\n  /* eslint-disable no-console */\n  console.log();\n  console.log(\n    `Configured servers:\n`,\n    JSON.stringify(servers, null, 2)\n  );\n  console.log();\n  console.log(\n    `Configured projects:\n`,\n    JSON.stringify(projects, null, 2)\n  );\n  console.log();\n  console.log(\n    'Reverse proxy paths: ',\n    JSON.stringify(config.reverseProxyPaths, null, 2)\n  );\n  console.log();\n\n  /* eslint-enable no-console */\n};\n\nexport default DisplayStartupConfiguration;\n","const fetchMyIp = async (env, configureLocalEndpoint) => {\n  /* eslint-disable no-console */\n  try {\n    const response = await fetch('https://api.ipify.org?format=json', {\n      method: 'GET',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n    });\n\n    const ipJson = await response.json();\n    console.log(`Current public ip -> ${JSON.stringify(ipJson)}`);\n    if (ipJson.ip.startsWith('185.18.13')) {\n      console.log(\n        `Using local endpoint for ${env.alias} -> ${env.internalVip}`\n      );\n      configureLocalEndpoint();\n    } else {\n      console.log(`Outside Zengenti network, use real DNS.`);\n    }\n  } catch (error) {\n    console.log(\n      `Could not work out where I am so defaulting to local DNS, as I am probably running as a container this is what matters most. Not developers at home or tests :( Sorry. error: ${error}`\n    );\n    configureLocalEndpoint();\n  }\n\n  /* eslint-enable no-console */\n};\n\nexport default fetchMyIp;\n","import evilDns from 'evil-dns';\nimport fetchMyIp from '../util/fetchMyIp';\n\nconst servers = SERVERS; /* global SERVERS */\nconst apiConfig = DELIVERY_API_CONFIG; /* global DELIVERY_API_CONFIG */\n\nconst localDns = async () => {\n  const disableDnsChanges = false;\n\n  const configureLocalEndpoint = () => {\n    if (!disableDnsChanges) {\n      evilDns.add(`*${servers.alias}.cloud.contensis.com`, servers.internalVip);\n\n      if (apiConfig.internalIp)\n        evilDns.add(apiConfig.rootUrl, apiConfig.internalIp);\n    }\n  };\n\n  // Break api.ipify to test\n  // evilDns.add('api.ipify.org', '8.8.8.8');\n  await fetchMyIp(servers, configureLocalEndpoint);\n};\n\nexport default localDns;\n","import httpProxy from 'http-proxy';\n\nconst servers = SERVERS; /* global SERVERS */\nexport const apiProxy = httpProxy.createProxyServer();\n\nconst reverseProxies = (app, reverseProxyPaths) => {\n  deliveryApiProxy(apiProxy, app);\n\n  app.all(reverseProxyPaths, (req, res) => {\n    const target =\n      req.hostname.indexOf('preview-') ||\n      req.hostname.indexOf('preview.') ||\n      req.hostname === 'localhost'\n        ? servers.previewIis || servers.iis\n        : servers.iis;\n\n    apiProxy.web(req, res, { target, changeOrigin: true });\n    apiProxy.on('error', e => {\n      /* eslint-disable no-console */\n      console.log(\n        `Proxy Request for ${req.path} HostName:${req.hostname} failed with ${e}`\n      );\n      /* eslint-enable no-console */\n    });\n  });\n};\n\nconst deliveryApiProxy = (apiProxy, app) => {\n  // This is just here to stop cors requests on localhost. In Production this is mapped using varnish.\n  app.all(['/api/delivery/*', '/api/image/*'], (req, res) => {\n    /* eslint-disable no-console */\n    const target = servers.cms;\n    console.log(`Proxying api request to ${servers.alias}`);\n    apiProxy.web(req, res, {\n      target,\n      changeOrigin: true,\n    });\n    apiProxy.on('error', e => {\n      /* eslint-disable no-console */\n      console.log(\n        `Proxy request for ${req.path} HostName:${req.hostname} failed with ${e}`\n      );\n      /* eslint-enable no-console */\n    });\n  });\n};\n\nexport default reverseProxies;\n","export const AccessMethods = {\n  DYNAMIC: 'dynamic',\n  STATIC: 'static',\n  FRAGMENT: 'fragment',\n  REDUX: 'redux',\n};\n\nexport const ResponseMethod = {\n  send: 'send',\n  json: 'json',\n  end: 'end',\n};\n","/* eslint-disable no-console */\nimport { ResponseMethod } from './types';\n\n/**\n * Web Application Response handler, sends a prepared express js response\n * with the supplied content sending in the specified manner\n * @param {response} request express js request object\n * @param {response} response express js response object\n * @param {string | object} content the content to send in the response body\n * @param {function} send the response function to call e.g res.send() res.json() res.end()\n */\nconst handleResponse = (\n  request,\n  response,\n  content,\n  send = ResponseMethod.send\n) => {\n  // console.log('---', response.statusCode, '---');\n  response[send](content);\n};\n\nexport default handleResponse;\n","export const hashKeys = keys => {\n  const XXHash = require('xxhashjs');\n  const returnKeys = [];\n  keys.forEach(cacheKey => {\n    const inputBuffer = Buffer.from(cacheKey.toLowerCase(), 'utf-8');\n\n    const hashed = XXHash.h32(inputBuffer, 0x0).toString(16);\n    const reversedhex = hashed\n      .match(/[a-fA-F0-9]{2}/g)\n      .reverse()\n      .join('');\n\n    const outputBuffer = Buffer.from(reversedhex, 'hex');\n\n    returnKeys.push(outputBuffer.toString('base64').substring(0, 6));\n  });\n  return returnKeys;\n};\n","import fs from 'fs';\nimport React from 'react';\nimport { StaticRouter } from 'react-router-dom';\nimport { Provider as ReduxProvider } from 'react-redux';\nimport Loadable from 'react-loadable';\nimport { renderToString } from 'react-dom/server';\nimport { getBundles } from 'react-loadable/webpack';\nimport { ServerStyleSheet } from 'styled-components';\nimport Helmet from 'react-helmet';\nimport serialize from 'serialize-javascript';\nimport minifyCssString from 'minify-css-string';\nimport { fromJS } from 'immutable';\nimport fromEntries from 'fromentries';\n\nimport { history } from '~/core/redux/history';\n\nimport { AccessMethods } from '../util/types';\nimport handleResponse from '../util/handleResponse';\nimport { hashKeys } from '../util/cacheHashing';\n\nimport pickProject from '~/core/util/pickProject';\nimport { GetDeliveryApiStatusFromHostname } from '~/core/util/ContensisDeliveryApi';\n\nimport { setCurrentProject } from '~/core/redux/actions/routing';\nimport { setVersion, setVersionStatus } from '~/core/redux/actions/version';\n\nimport {\n  selectCurrentProject,\n  selectCurrentTreeID,\n  selectEntryDepends,\n  selectNodeDepends,\n  selectRouteEntry,\n} from '~/core/redux/selectors/routing';\n\nimport createStore from '~/core/redux/store';\nimport rootSaga from '~/core/redux/sagas/index.js';\nimport { matchRoutes } from 'react-router-config';\n\nconst moduleBundles = fs.readdirSync('./dist/static/modern/js', 'utf8');\nconst coreModules = moduleBundles.filter(\n  m =>\n    m.startsWith('app.') || m.startsWith('vendor.') || m.startsWith('runtime.')\n);\n\nconst addStandardHeaders = (state, response, packagejson, groups) => {\n  if (state) {\n    /* eslint-disable no-console */\n    try {\n      console.log('About to add header');\n      let entryDepends = selectEntryDepends(state);\n      entryDepends = Array.from(entryDepends || {});\n      console.log(`entryDepends count: ${entryDepends.length}`);\n\n      let nodeDepends = selectNodeDepends(state).toJS();\n      let currentTreeId = selectCurrentTreeID(state);\n      let nodeDependsKeys = nodeDepends.map(nodeKey => {\n        return `${currentTreeId}_${nodeKey}`;\n      });\n      const allDepends = [...entryDepends, ...nodeDependsKeys];\n      const allDependsHashed = hashKeys(allDepends);\n\n      const surrogateKeyHeader =\n        packagejson.name == 'os-main'\n          ? ` ${packagejson.name}-app ${allDependsHashed.join(\n              ' '\n            )} ${allDepends.join(' ')}`\n          : ` ${packagejson.name}-app ${allDependsHashed.join(' ')}`;\n\n      response.header('surrogate-key', surrogateKeyHeader);\n\n      console.log(`depends hashed: ${allDependsHashed.join(' ')}`);\n      console.log(`depends hashed: ${allDepends.join(' ')}`);\n\n      addVarnishAuthenticationHeaders(state, response, groups);\n\n      response.setHeader('Surrogate-Control', 'max-age=3600');\n      response.setHeader(\n        'Link',\n        coreModules\n          .map(m => `</static/modern/js/${m}>;rel=\"preload\";as=\"script\"`)\n          .join(',')\n      );\n    } catch (e) {\n      console.log('Error Adding headers', e.message);\n      // console.log(e);\n    }\n  }\n};\n\nconst addVarnishAuthenticationHeaders = (state, response, groups = {}) => {\n  if (state) {\n    try {\n      const stateEntry = selectRouteEntry(state);\n      const project = selectCurrentProject(state);\n      const { globalGroups, allowedGroups } = groups;\n      // console.log(globalGroups, allowedGroups);\n      let allGroups = Array.from((globalGroups && globalGroups[project]) || {});\n      if (\n        stateEntry &&\n        stateEntry.getIn(['authentication', 'isLoginRequired']) &&\n        allowedGroups &&\n        allowedGroups[project]\n      ) {\n        allGroups = [...allGroups, ...allowedGroups[project]];\n      }\n      response.header('x-contensis-viewer-groups', allGroups.join('|'));\n    } catch (e) {\n      console.log('Error adding authentication header');\n      console.log(e);\n    }\n  }\n};\n\nconst readFileSync = path => fs.readFileSync(path, 'utf8');\n\nconst loadBundleData = ({ stats, templates }, build) => {\n  const bundle = {};\n  try {\n    bundle.stats = JSON.parse(\n      readFileSync(stats.replace('/target', build ? `/${build}` : ''))\n    );\n  } catch (ex) {\n    //console.log(ex);\n    bundle.stats = null;\n  }\n  try {\n    bundle.templates = {\n      templateHTML: readFileSync(\n        templates.html.replace('/target', build ? `/${build}` : '')\n      ),\n      templateHTMLStatic: readFileSync(\n        templates.static.replace('/target', build ? `/${build}` : '')\n      ),\n      templateHTMLFragment: readFileSync(\n        templates.fragment.replace('/target', build ? `/${build}` : '')\n      ),\n    };\n  } catch (ex) {\n    //console.log(ex);\n    bundle.templates = null;\n  }\n  return bundle;\n};\n\nconst webApp = (app, ReactApp, config) => {\n  const {\n    routes,\n    withReducers,\n    withSagas,\n    withEvents,\n    packagejson,\n    versionData,\n    differentialBundles,\n    dynamicPaths,\n    allowedGroups,\n    globalGroups,\n    disableSsrRedux,\n    handleResponses,\n  } = config;\n\n  const bundles = {\n    default: loadBundleData(config),\n    legacy: loadBundleData(config, 'legacy'),\n    modern: loadBundleData(config, 'modern'),\n  };\n  if (!bundles.default || bundles.default === {})\n    bundles.default = bundles.legacy || bundles.modern;\n\n  const versionInfo = JSON.parse(fs.readFileSync(versionData, 'utf8'));\n\n  const responseHandler =\n    typeof handleResponses === 'function' ? handleResponses : handleResponse;\n\n  app.get('/*', (request, response, next) => {\n    if (request.originalUrl.startsWith('/static/')) return next();\n    const { url } = request;\n\n    const matchedStaticRoute = () =>\n      matchRoutes(routes.StaticRoutes, request.path);\n    const isStaticRoute = () => matchedStaticRoute().length > 0;\n    const staticRoute = isStaticRoute() && matchedStaticRoute()[0];\n\n    // Determine functional params and set access methods\n    let accessMethod = {};\n\n    const isDynamicNormalised = request.query.dynamic\n      ? request.query.dynamic.toLowerCase()\n      : 'false';\n\n    // Hack for certain pages to avoid SSR\n    const onlyDynamic =\n      dynamicPaths.includes(request.path) ||\n      (staticRoute && staticRoute.route.ssr === false);\n\n    const isReduxRequestNormalised = request.query.redux\n      ? request.query.redux.toLowerCase()\n      : 'false';\n\n    const isFragmentNormalised = request.query.fragment\n      ? request.query.fragment.toLowerCase()\n      : 'false';\n\n    const isStaticNormalised = request.query.static\n      ? request.query.static.toLowerCase()\n      : 'false';\n\n    if (onlyDynamic || isDynamicNormalised === 'true')\n      accessMethod.DYNAMIC = AccessMethods.DYNAMIC;\n    if (isReduxRequestNormalised === 'true')\n      accessMethod.REDUX = AccessMethods.REDUX;\n    if (isFragmentNormalised === 'true')\n      accessMethod.FRAGMENT = AccessMethods.FRAGMENT;\n    if (isStaticNormalised === 'true')\n      accessMethod.STATIC = AccessMethods.STATIC;\n\n    const context = {};\n    let status = 200;\n\n    // Create a store (with a memory history) from our current url\n    const store = createStore(\n      withReducers,\n      fromJS({}),\n      history({ initialEntries: [url] })\n    );\n    //const store = createStore(withReducers);\n\n    // dispatch any global and non-saga related actions before calling our JSX\n    const versionStatusFromHostname = GetDeliveryApiStatusFromHostname(\n      request.hostname\n    );\n\n    store.dispatch(\n      setVersionStatus(request.query.versionStatus || versionStatusFromHostname)\n    );\n    store.dispatch(setVersion(versionInfo.commitRef, versionInfo.buildNo));\n\n    const project = pickProject(request.hostname, request.query);\n\n    const groups = allowedGroups && allowedGroups[project];\n    store.dispatch(setCurrentProject(project, groups));\n\n    const modules = [];\n\n    const jsx = (\n      <Loadable.Capture report={moduleName => modules.push(moduleName)}>\n        <ReduxProvider store={store}>\n          <StaticRouter context={context} location={url}>\n            <ReactApp routes={routes} withEvents={withEvents} />\n          </StaticRouter>\n        </ReduxProvider>\n      </Loadable.Capture>\n    );\n\n    /* eslint-disable no-console */\n    console.log(\n      `Request for ${request.path} hostname: ${request.hostname} versionStatus: ${versionStatusFromHostname}`\n    );\n    /* eslint-enable no-console */\n\n    const templates = bundles.default.templates || bundles.legacy.templates;\n    const stats =\n      bundles.modern.stats && bundles.legacy.stats\n        ? fromEntries(\n            Object.entries(bundles.modern.stats).map(([lib, paths]) => [\n              lib,\n              bundles.legacy.stats[lib]\n                ? [...paths, ...bundles.legacy.stats[lib]]\n                : paths,\n            ])\n          )\n        : bundles.default.stats;\n\n    const {\n      templateHTML,\n      templateHTMLFragment,\n      templateHTMLStatic,\n    } = templates;\n\n    // Serve a blank HTML page with client scripts to load the app in the browser\n    if (accessMethod.DYNAMIC) {\n      // Dynamic doesn't need sagas\n      renderToString(jsx);\n\n      const isDynamicHint = `<script>window.isDynamic = true;</script>`;\n      const dynamicBundles = getBundles(stats, modules);\n      const dynamicBundleScripts = dynamicBundles\n        .map(bundle => {\n          if (bundle.publicPath.includes('/modern/'))\n            return differentialBundles\n              ? `<script type=\"module\" src=\"${bundle.publicPath}\"></script>`\n              : null;\n          return `<script nomodule src=\"${bundle.publicPath}\"></script>`;\n        })\n        .filter(f => f)\n        .join('');\n      const responseHtmlDynamic = templateHTML\n        .replace('{{TITLE}}', '')\n        .replace('{{SEO_CRITICAL_METADATA}}', '')\n        .replace('{{CRITICAL_CSS}}', '')\n        .replace('{{APP}}', '')\n        .replace('{{LOADABLE_CHUNKS}}', dynamicBundleScripts)\n        .replace('{{REDUX_DATA}}', isDynamicHint);\n      response.setHeader('Surrogate-Control', 'max-age=3600');\n      response.status(status); //.send(responseHtmlDynamic);\n      responseHandler(request, response, responseHtmlDynamic);\n    }\n\n    // Render the JSX server side and send response as per access method options\n    if (!accessMethod.DYNAMIC) {\n      store\n        .runSaga(rootSaga(withSagas))\n        .toPromise()\n        .then(() => {\n          const sheet = new ServerStyleSheet();\n\n          const html = renderToString(sheet.collectStyles(jsx));\n\n          const helmet = Helmet.renderStatic();\n          Helmet.rewind();\n          let title = helmet.title.toString();\n          const metadata = helmet.meta.toString();\n\n          if (context.status === 404) {\n            status = 404;\n            title = '<title>404 page not found</title>';\n          }\n\n          if (context.url) {\n            return response.redirect(302, context.url);\n          }\n\n          const reduxState = store.getState();\n\n          const styleTags = sheet.getStyleTags();\n\n          const bundles = getBundles(stats, modules);\n\n          const bundleScripts = bundles\n            .map(bundle => {\n              if (bundle.publicPath.includes('/modern/'))\n                return differentialBundles\n                  ? `<script type=\"module\" src=\"${bundle.publicPath}\"></script>`\n                  : null;\n              return `<script nomodule src=\"${bundle.publicPath}\"></script>`;\n            })\n            .filter(f => f)\n            .join('');\n\n          let serialisedReduxData = '';\n          if (context.status !== 404) {\n            if (accessMethod.REDUX) {\n              serialisedReduxData = serialize(reduxState);\n              addStandardHeaders(reduxState, response, packagejson, {\n                allowedGroups,\n                globalGroups,\n              });\n              response.status(status); //.json(serialisedReduxData);\n              responseHandler(request, response, serialisedReduxData, 'json');\n              return true;\n            }\n            if (!disableSsrRedux) {\n              serialisedReduxData = serialize(reduxState);\n              serialisedReduxData = `<script>window.REDUX_DATA = ${serialisedReduxData}</script>`;\n            }\n          }\n          if (context.status === 404) {\n            accessMethod.STATIC = AccessMethods.STATIC;\n          }\n\n          // Responses\n          let responseHTML = '';\n\n          // Static page served as a fragment\n          if (accessMethod.FRAGMENT && accessMethod.STATIC) {\n            addStandardHeaders(reduxState, response, packagejson, {\n              allowedGroups,\n              globalGroups,\n            });\n            responseHTML = minifyCssString(styleTags) + html;\n          }\n\n          // Page fragment served with client scripts and redux data that hydrate the app client side\n          if (accessMethod.FRAGMENT && !accessMethod.STATIC) {\n            responseHTML = templateHTMLFragment\n              .replace('{{TITLE}}', title)\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\n              .replace('{{CRITICAL_CSS}}', minifyCssString(styleTags))\n              .replace('{{APP}}', html)\n              .replace('{{LOADABLE_CHUNKS}}', bundleScripts)\n              .replace('{{REDUX_DATA}}', serialisedReduxData);\n          }\n\n          // Full HTML page served statically\n          if (!accessMethod.FRAGMENT && accessMethod.STATIC) {\n            responseHTML = templateHTMLStatic\n              .replace('{{TITLE}}', title)\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\n              .replace('{{CRITICAL_CSS}}', minifyCssString(styleTags))\n              .replace('{{APP}}', html)\n              .replace('{{LOADABLE_CHUNKS}}', '');\n          }\n\n          // Full HTML page served with client scripts and redux data that hydrate the app client side\n          if (!accessMethod.FRAGMENT && !accessMethod.STATIC) {\n            responseHTML = templateHTML\n              .replace('{{TITLE}}', title)\n              .replace('{{SEO_CRITICAL_METADATA}}', metadata)\n              .replace('{{CRITICAL_CSS}}', styleTags)\n              .replace('{{APP}}', html)\n              .replace('{{LOADABLE_CHUNKS}}', bundleScripts)\n              .replace('{{REDUX_DATA}}', serialisedReduxData);\n          }\n          addStandardHeaders(reduxState, response, packagejson, {\n            allowedGroups,\n            globalGroups,\n          });\n          try {\n            response.status(status); //.send(responseHTML);\n            responseHandler(request, response, responseHTML);\n          } catch (err) {\n            // eslint-disable-next-line no-console\n            console.log(err.message);\n          }\n        })\n        .catch(err => {\n          // Handle any error that occurred in any of the previous\n          // promises in the chain.\n          /* eslint-disable no-console */\n          console.log(err);\n          /* eslint-enable no-console */\n          response.status(500);\n          responseHandler(\n            request,\n            response,\n            `Error occurred: <br />${err.stack} <br />${JSON.stringify(err)}`\n          );\n          // .send(\n          //   `Error occurred: <br />${err.stack} <br />${JSON.stringify(err)}`\n          // );\n        });\n      renderToString(jsx);\n\n      store.close();\n    }\n  });\n};\n\nexport default webApp;\n","import 'isomorphic-fetch';\nimport express from 'express';\nimport Loadable from 'react-loadable';\n\nimport DisplayStartupConfiguration from './util/displayStartupConfiguration';\nimport ConfigureLocalDNS from './core/localDns';\nimport ConfigureReverseProxies, { apiProxy } from './core/reverseProxies';\n// import ServerFeatures from './features/configure';\nimport ConfigureWebApp from './core/webApp';\n\nconst app = express();\n\nconst start = (ReactApp, config, ServerFeatures) => {\n  app.disable('x-powered-by');\n\n  // Output some information about the used build/startup configuration\n  DisplayStartupConfiguration(config);\n\n  // Set-up local proxy for images from cms, to save doing rewrites and extra code\n  ServerFeatures(app);\n  ConfigureReverseProxies(app, config.reverseProxyPaths);\n  ConfigureWebApp(app, ReactApp, config);\n\n  app.use('/static', express.static('dist/static', { maxage: '31557600h' }));\n\n  app.on('ready', async () => {\n    // Configure DNS to make life easier\n    await ConfigureLocalDNS();\n\n    Loadable.preloadAll().then(() => {\n      var server = app.listen(3001, () => {\n        console.info(`HTTP server is listening @ port 3001`);\n        setTimeout(function() {\n          app.emit('app_started');\n        }, 500);\n      });\n      app.on('stop', () => {\n        server.close(function() {\n          console.info('GoodBye :(');\n        });\n      });\n    });\n  });\n};\n\nexport default { app, apiProxy, start };\n"],"names":["servers","SERVERS","projects","PROJECTS","DisplayStartupConfiguration","config","console","log","JSON","stringify","reverseProxyPaths","fetchMyIp","env","configureLocalEndpoint","response","fetch","method","headers","ipJson","json","ip","startsWith","alias","internalVip","error","apiConfig","DELIVERY_API_CONFIG","localDns","evilDns","add","internalIp","rootUrl","apiProxy","httpProxy","createProxyServer","reverseProxies","app","deliveryApiProxy","all","req","res","target","hostname","indexOf","previewIis","iis","web","changeOrigin","on","e","path","cms","AccessMethods","DYNAMIC","STATIC","FRAGMENT","REDUX","ResponseMethod","send","end","handleResponse","request","content","hashKeys","keys","XXHash","require","returnKeys","forEach","cacheKey","inputBuffer","Buffer","from","toLowerCase","hashed","h32","toString","reversedhex","match","reverse","join","outputBuffer","push","substring","moduleBundles","fs","readdirSync","coreModules","filter","m","addStandardHeaders","state","packagejson","groups","entryDepends","selectEntryDepends","Array","length","nodeDepends","selectNodeDepends","toJS","currentTreeId","selectCurrentTreeID","nodeDependsKeys","map","nodeKey","allDepends","allDependsHashed","surrogateKeyHeader","name","header","addVarnishAuthenticationHeaders","setHeader","message","stateEntry","selectRouteEntry","project","selectCurrentProject","globalGroups","allowedGroups","allGroups","getIn","readFileSync","loadBundleData","stats","templates","build","bundle","parse","replace","ex","templateHTML","html","templateHTMLStatic","static","templateHTMLFragment","fragment","webApp","ReactApp","routes","withReducers","withSagas","withEvents","versionData","differentialBundles","dynamicPaths","disableSsrRedux","handleResponses","bundles","default","legacy","modern","versionInfo","responseHandler","get","next","originalUrl","url","matchedStaticRoute","matchRoutes","StaticRoutes","isStaticRoute","staticRoute","accessMethod","isDynamicNormalised","query","dynamic","onlyDynamic","includes","route","ssr","isReduxRequestNormalised","redux","isFragmentNormalised","isStaticNormalised","context","status","store","createStore","fromJS","history","initialEntries","versionStatusFromHostname","GetDeliveryApiStatusFromHostname","dispatch","setVersionStatus","versionStatus","setVersion","commitRef","buildNo","pickProject","setCurrentProject","modules","jsx","moduleName","ReduxProvider","fromEntries","Object","entries","lib","paths","renderToString","isDynamicHint","dynamicBundles","getBundles","dynamicBundleScripts","publicPath","f","responseHtmlDynamic","runSaga","rootSaga","toPromise","then","sheet","ServerStyleSheet","collectStyles","helmet","Helmet","renderStatic","rewind","title","metadata","meta","redirect","reduxState","getState","styleTags","getStyleTags","bundleScripts","serialisedReduxData","serialize","responseHTML","minifyCssString","err","catch","stack","close","express","start","ServerFeatures","disable","ConfigureReverseProxies","ConfigureWebApp","use","maxage","ConfigureLocalDNS","Loadable","preloadAll","server","listen","info","setTimeout","emit"],"mappings":"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"}
>>>>>>> isomorphic-base
